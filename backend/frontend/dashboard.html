<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Gestor de Reservas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
    <link href="css/dashboard.css" rel="stylesheet">
    <style>
        #detail-modal {
            background-color: rgba(0, 0, 0, 0.5);
        }

        tbody tr:hover {
            background-color: #f9fafb;
            cursor: pointer;
        }
    </style>
</head>

<body class="bg-gray-100">
    <div id="loader" class="text-center p-8">
        <p class="text-gray-500">Verificando sesi칩n...</p>
    </div>

    <div id="app-content" class="min-h-screen hidden">
        <nav class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <h1 class="text-xl font-bold text-gray-800">Gestor de Reservas</h1>
                    <div id="auth-info" class="flex items-center space-x-4"></div>
                </div>
            </div>
        </nav>
        <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">

            <div class="bg-white p-8 rounded-lg shadow mb-8">
                <h2 class="text-2xl font-semibold text-gray-900 mb-4">An치lisis de Rendimiento (KPIs)</h2>
                <div class="flex flex-col md:flex-row items-end space-y-4 md:space-y-0 md:space-x-4 mb-6 pb-6 border-b">
                    <div>
                        <label for="kpi-fecha-inicio" class="block text-sm font-medium text-gray-700">Fecha de
                            Inicio</label>
                        <input type="date" id="kpi-fecha-inicio"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                    <div>
                        <label for="kpi-fecha-fin" class="block text-sm font-medium text-gray-700">Fecha de Fin</label>
                        <input type="date" id="kpi-fecha-fin"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                    <div class="w-full md:w-auto">
                        <label for="kpi-proyeccion-slider" class="block text-sm font-medium text-gray-700">Proyecci칩n
                            Ocupaci칩n (<span id="proyeccion-valor">70</span>%)</label>
                        <input type="range" id="kpi-proyeccion-slider" min="0" max="100" value="70" class="mt-1 w-full">
                    </div>
                    <div class="pt-0 md:pt-6">
                        <button id="kpi-calculate-btn"
                            class="w-full md:w-auto bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700">
                            Calcular
                        </button>
                    </div>
                </div>

                <div id="kpi-loading" class="text-center text-gray-500 hidden">
                    <p>Calculando KPIs, esto puede tardar unos segundos...</p>
                </div>

                <div id="kpi-warning-container"
                    class="hidden my-4 p-3 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700"></div>

                <div id="kpi-results-container" class="hidden space-y-8">
                    <div id="kpi-cards" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 text-center"></div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-1">
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">Distribuci칩n por Canal</h3>
                            <div id="canal-details-table" class="overflow-x-auto"></div>
                        </div>
                        <div class="lg:col-span-2">
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">Ranking de Ocupaci칩n por Caba침a</h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">
                                                Caba침a</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">
                                                # Noches Ocupadas</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">
                                                Noches Faltantes (Proy.)</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">
                                                Ingreso Real</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">
                                                Descuento Real</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ranking-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Workflow (Flujo Diario) -->
            <div class="bg-white p-8 rounded-lg shadow mb-8">
                <h2 class="text-2xl font-semibold text-gray-900 mb-4">Flujo de Trabajo Diario</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <button id="btn-workflow-incidencias"
                        class="workflow-btn bg-white border-2 border-red-100 p-8 rounded-xl flex items-center justify-between hover:border-red-300 group">
                        <div class="flex items-center">
                            <div class="bg-red-100 p-4 rounded-full mr-6 group-hover:bg-red-200 transition">
                                <span class="text-3xl">丘멆잺</span>
                            </div>
                            <div class="text-left">
                                <h3 class="text-xl font-bold text-gray-900">Incidencias</h3>
                                <p class="text-gray-500">Reportes de imprevistos</p>
                            </div>
                        </div>
                        <div id="badge-incidencias" class="badge hidden">0</div>
                    </button>

                    <button id="btn-workflow-actividades"
                        class="workflow-btn bg-white border-2 border-blue-100 p-8 rounded-xl flex items-center justify-between hover:border-blue-300 group">
                        <div class="flex items-center">
                            <div class="bg-blue-100 p-4 rounded-full mr-6 group-hover:bg-blue-200 transition">
                                <span class="text-3xl">游늶</span>
                            </div>
                            <div class="text-left">
                                <h3 class="text-xl font-bold text-gray-900">Control de Actividades</h3>
                                <p class="text-gray-500">Avance del plan diario</p>
                            </div>
                        </div>
                        <div id="badge-actividades" class="badge hidden">0</div>
                    </button>

                    <button id="btn-config-tasks"
                        class="workflow-btn bg-white border-2 border-indigo-100 p-8 rounded-xl flex items-center justify-between hover:border-indigo-300 group md:col-span-2 lg:col-span-1">
                        <div class="flex items-center">
                            <div class="bg-indigo-100 p-4 rounded-full mr-6 group-hover:bg-indigo-200 transition">
                                <span class="text-3xl">丘뙖잺</span>
                            </div>
                            <div class="text-left">
                                <h3 class="text-xl font-bold text-gray-900">Configurar Tareas</h3>
                                <p class="text-gray-500">Protocolos, Tiempos y Checklists</p>
                            </div>
                        </div>
                    </button>
                </div>
            </div>


            <!-- Historial Modal -->

            <div class="bg-white p-8 rounded-lg shadow">
                <h2 class="text-2xl font-semibold text-gray-900 mb-4">Herramientas de Gesti칩n</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    <a href="gestion.html"
                        class="relative bg-red-600 text-white p-6 rounded-lg text-center font-semibold hover:bg-red-700 transition shadow">
                        <span id="gestion-badge"
                            class="absolute -top-2 -right-2 bg-red-800 text-white text-xs font-bold rounded-full h-6 w-6 flex items-center justify-center hidden"></span>
                        <span class="text-3xl">!</span>
                        <p class="mt-2">Gesti칩n Diaria</p>
                    </a>
                    <a href="calendario.html"
                        class="bg-cyan-600 text-white p-6 rounded-lg text-center font-semibold hover:bg-cyan-700 transition shadow flex items-center justify-center">
                        <p>Calendario de Ocupaci칩n</p>
                    </a>
                    <a href="agregar-reserva.html"
                        class="bg-green-600 text-white p-6 rounded-lg text-center font-semibold hover:bg-green-700 transition shadow flex items-center justify-center">
                        <p>Agregar Propuesta</p>
                    </a>
                    <a href="propuestas.html"
                        class="bg-yellow-500 text-white p-6 rounded-lg text-center font-semibold hover:bg-yellow-600 transition shadow flex items-center justify-center">
                        <p>Gestionar Propuestas</p>
                    </a>
                    <a href="reportes.html"
                        class="bg-pink-500 text-white p-6 rounded-lg text-center font-semibold hover:bg-pink-600 transition shadow flex items-center justify-center">
                        <p>Generar Reportes R치pidos</p>
                    </a>
                    <a href="planificador.html"
                        class="bg-indigo-500 text-white p-6 rounded-lg text-center font-semibold hover:bg-indigo-600 transition shadow flex items-center justify-center">
                        <p>Planificaci칩n Operativa</p>
                    </a>
                    <!-- NEW: Historial Operativo Button -->
                    <button id="abrir-historial-btn"
                        class="bg-gray-600 text-white p-6 rounded-lg text-center font-semibold hover:bg-gray-700 transition shadow flex items-center justify-center">
                        <p>Historial Operativo</p>
                    </button>
                </div>
            </div>
            <div class="bg-white p-8 rounded-lg shadow mt-8">
                <h2 class="text-2xl font-semibold text-gray-900 mb-4">Herramientas y Configuraci칩n</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    <a href="clientes.html"
                        class="bg-blue-600 text-white p-6 rounded-lg text-center font-semibold hover:bg-blue-700 transition shadow">Gestionar
                        Clientes</a>
                    <a href="reservas.html"
                        class="bg-white border border-gray-300 p-6 rounded-lg text-center font-medium text-gray-700 hover:bg-gray-50 transition">Ver
                        y Editar Reservas</a>
                    <a href="tarifas.html"
                        class="bg-purple-600 text-white p-6 rounded-lg text-center font-semibold hover:bg-purple-700 transition shadow">Gestionar
                        Tarifas</a>
                    <a href="sincronizar.html"
                        class="bg-indigo-600 text-white p-6 rounded-lg text-center font-semibold hover:bg-indigo-700 transition shadow">Sincronizar
                        Datos</a>
                    <a href="procesar.html"
                        class="bg-teal-600 text-white p-6 rounded-lg text-center font-semibold hover:bg-teal-700 transition shadow">Procesar
                        y Consolidar</a>
                    <a href="sincronizacion-ical.html"
                        class="bg-orange-500 text-white p-6 rounded-lg text-center font-semibold hover:bg-orange-600 transition shadow">Sincronizar
                        Calendarios (iCal)</a>
                    <a href="mensajes.html"
                        class="bg-gray-700 text-white p-6 rounded-lg text-center font-semibold hover:bg-gray-800 transition shadow">Generar
                        Mensajes</a>
                    <a href="presupuestos.html"
                        class="bg-pink-600 text-white p-6 rounded-lg text-center font-semibold hover:bg-pink-700 transition shadow">Generar
                        Presupuestos</a>
                    <a href="gestion-cabanas.html"
                        class="bg-cyan-600 text-white p-6 rounded-lg text-center font-semibold hover:bg-cyan-700 transition shadow">Gestionar
                        Caba침as</a>
                    <a href="autorizar.html"
                        class="bg-red-500 text-white p-6 rounded-lg text-center font-semibold hover:bg-red-600 transition shadow">Autorizar
                        Google Contacts</a>

                    <!-- NEW: Configuraci칩n Maestra Button -->
                    <button id="abrir-settings-btn"
                        class="bg-slate-800 text-white p-6 rounded-lg text-center font-semibold hover:bg-slate-900 transition shadow flex items-center justify-center">
                        <p>Configuraci칩n Maestra</p>
                    </button>
                </div>
            </div>

            <!-- Settings Removed from Main Flow (Moved to Modal) -->
            <div class="bg-white p-8 rounded-lg shadow mt-8">
                <h2 class="text-2xl font-semibold text-gray-900 mb-4">Herramientas de Mantenimiento</h2>
                <div class="space-y-4">
                    <div>
                        <p class="text-gray-600 mb-2">Si las reservas antiguas no aparecen en "Gesti칩n Diaria", usa este
                            bot칩n una vez para reparar los datos.</p>
                        <button id="repair-btn"
                            class="w-full sm:w-auto inline-flex justify-center items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-gray-700 hover:bg-gray-800">
                            Reparar Estados de Reservas
                        </button>
                        <div id="repair-status" class="mt-4 p-4 rounded-md hidden"></div>
                    </div>
                    <div class="border-t pt-4 mt-4">
                        <p class="text-gray-600 mb-2">Si las reservas de Booking aparecen sin tel칠fono en "Gesti칩n
                            Diaria", usa este bot칩n una vez para repararlas.</p>
                        <button id="repair-phones-btn"
                            class="w-full sm:w-auto inline-flex justify-center items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-gray-700 hover:bg-gray-800">
                            Reparar Tel칠fonos Faltantes
                        </button>
                        <div id="repair-phones-status" class="mt-4 p-4 rounded-md hidden"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    </div>

    <footer class="bg-white mt-12 py-6 border-t">
        <div class="max-w-7xl mx-auto px-4 text-center text-gray-400 text-sm">
            <p>Gestor de Reservas &copy; 2025 - Orillas del Coilaco</p>
            <p class="mt-1">Versi칩n 2.8 (Decimal Weights)</p>
        </div>
    </footer>

    <!-- Detail Modal -->
    <div id="detail-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
            <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4" id="detail-modal-title">Detalle por Canal</h3>
            <div id="detail-modal-content"></div>
            <button type="button" id="detail-modal-close-btn"
                class="mt-4 w-full inline-flex justify-center rounded-md border border-gray-300 px-4 py-2 bg-white text-base font-medium text-gray-700 shadow-sm hover:bg-gray-50">Cerrar</button>
        </div>
    </div>

    <!-- Modal Historial Operativo -->
    <div id="modal-historial"
        class="fixed inset-0 z-50 flex items-center justify-center hidden bg-black bg-opacity-50 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl p-0 w-full max-w-6xl max-h-[90vh] flex flex-col">
            <div class="p-6 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
                <h3 class="text-xl font-bold text-gray-900">Historial Operativo y Auditor칤a</h3>
                <button id="cerrar-historial-btn" class="text-gray-400 hover:text-gray-600 transition">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="p-6 overflow-y-auto">
                <!-- Filters -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Desde</label>
                        <input type="date" id="hist_start"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Hasta</label>
                        <input type="date" id="hist_end"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Caba침a</label>
                        <select id="hist_cabana"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50">
                            <option value="">Todas</option>
                            <option value="Caba침a 1">Caba침a 1</option>
                            <option value="Caba침a 2">Caba침a 2</option>
                            <option value="Caba침a 10">Caba침a 10</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Espacio</label>
                        <select id="hist_space"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50">
                            <option value="">Todos</option>
                            <!-- JS will populate -->
                        </select>
                    </div>
                    <div class="md:col-span-4 flex justify-end gap-3">
                        <button id="btn-load-history"
                            class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 font-medium">
                            Consultar Historial
                        </button>
                        <button id="btn-download-report"
                            class="bg-gray-800 text-white px-4 py-2 rounded-md hover:bg-gray-900 font-medium flex items-center">
                            <span class="mr-2">游닌</span> Descargar PDF
                        </button>
                    </div>
                </div>
                <!-- Table -->
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Fecha
                                </th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Tipo
                                </th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Caba침a / Espacio</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Detalle</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Usuario</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Estado</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>


    <!-- Modal Configuracion Maestra -->
    <div id="modal-settings"
        class="fixed inset-0 z-50 flex items-center justify-center hidden bg-black bg-opacity-50 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl p-0 w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="p-6 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
                <h3 class="text-xl font-bold text-gray-900">Configuraci칩n Maestra</h3>
                <button id="cerrar-settings-btn" class="text-gray-400 hover:text-gray-600 transition">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="p-6">
                <form id="settings-form" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="nombreEmpresa" class="block text-sm font-medium text-gray-700">Nombre
                                Empresa</label>
                            <input type="text" id="nombreEmpresa" name="nombreEmpresa"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                        </div>
                        <div>
                            <label for="adminNombre" class="block text-sm font-medium text-gray-700">Nombre
                                Administrador</label>
                            <input type="text" id="adminNombre" name="adminNombre"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                        </div>
                        <div>
                            <label for="adminEmail" class="block text-sm font-medium text-gray-700">Email
                                Administrador</label>
                            <input type="email" id="adminEmail" name="adminEmail"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                        </div>
                        <div>
                            <label for="telefonoContacto" class="block text-sm font-medium text-gray-700">Tel칠fono
                                Contacto</label>
                            <input type="text" id="telefonoContacto" name="telefonoContacto"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                        </div>
                        <div>
                            <label for="telegramChatId" class="block text-sm font-medium text-gray-700">Telegram Chat
                                ID (Admin)</label>
                            <input type="text" id="telegramChatId" name="telegramChatId"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                            <p class="text-xs text-gray-500 mt-1">ID para alertas administrativas.</p>
                        </div>
                        <div>
                            <label for="workerChatId" class="block text-sm font-medium text-gray-700">Telegram Chat
                                ID (Trabajador)</label>
                            <input type="text" id="workerChatId" name="workerChatId"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                            <p class="text-xs text-gray-500 mt-1">ID para env칤o de plan diario.</p>
                        </div>
                        <div class="md:col-span-2">
                            <label for="botToken" class="block text-sm font-medium text-gray-700">Telegram Bot
                                Token</label>
                            <input type="password" id="botToken" name="botToken"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border"
                                placeholder="123456789:ABC...">
                            <p class="text-xs text-gray-500 mt-1">Token del bot creado con @BotFather.</p>
                        </div>
                    </div>
                    <div>
                        <button type="submit" id="save-settings-btn"
                            class="bg-gray-800 text-white px-4 py-2 rounded-md hover:bg-gray-900">
                            Guardar Configuraci칩n
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Configuraci칩n de Tareas -->
    <div id="task-config-modal" class="fixed inset-0 z-50 hidden modal-overlay flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-6xl h-[90vh] rounded-xl flex shadow-2xl overflow-hidden slide-up-animation">

            <!-- Left: List -->
            <div class="w-1/3 border-r bg-gray-50 flex flex-col">
                <div class="p-4 border-b bg-white">
                    <h3 class="text-lg font-bold text-gray-800">Tipos de Tarea</h3>
                    <p class="text-xs text-gray-500">Haz clic en editar para ver detalles</p>
                </div>
                <div id="task-types-list" class="flex-1 overflow-y-auto p-4 space-y-2">
                    <!-- Dynamic List -->
                </div>
                <div class="p-4 border-t bg-white">
                    <button onclick="document.getElementById('task-type-form').reset()"
                        class="w-full py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 font-semibold">
                        + Nueva Tarea
                    </button>
                </div>
            </div>

            <!-- Right: Form -->
            <div class="w-2/3 flex flex-col bg-white">
                <div class="p-6 border-b flex justify-between items-center">
                    <h3 class="text-xl font-bold text-blue-900">Editor de Protocolo</h3>
                    <button id="btn-cancel-task-type" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <div class="flex-1 overflow-y-auto p-8">
                    <form id="task-type-form" class="space-y-6">
                        <div class="grid grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nombre Tarea
                                    (ID)</label>
                                <input type="text" id="task-name"
                                    class="w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="Ej: Limpieza Salida" required>
                                <p class="text-xs text-orange-500 mt-1">Debe coincidir con lo asignado
                                    en el Planificador</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Color
                                    Identificador</label>
                                <input type="color" id="task-color"
                                    class="w-full h-10 border-gray-300 rounded-md shadow-sm" value="#3B82F6">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Descripci칩n</label>
                            <textarea id="task-desc" rows="2" class="w-full border-gray-300 rounded-md shadow-sm"
                                placeholder="Descripci칩n breve para la tarjeta..."></textarea>
                        </div>

                        <div class="grid grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Peso
                                    (Prioridad)</label>
                                <input type="number" id="task-weight"
                                    class="w-full border-gray-300 rounded-md shadow-sm" value="1" min="0.1" step="0.1">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Duraci칩n
                                    (min)</label>
                                <input type="number" id="task-duration"
                                    class="w-full border-gray-300 rounded-md shadow-sm" value="30" step="5">
                            </div>
                        </div>

                        <div class="border-t pt-4">
                            <div class="flex justify-between items-center mb-4">
                                <label class="block text-lg font-medium text-gray-800">Ckecklist
                                    (Protocolo)</label>
                                <button type="button" id="btn-add-checklist-item"
                                    class="text-sm text-blue-600 font-bold hover:underline">+ Agregar
                                    Paso</button>
                            </div>
                            <div id="checklist-items-container"
                                class="space-y-3 bg-gray-50 p-4 rounded-lg min-h-[200px]">
                                <!-- Checklist Items -->
                            </div>
                        </div>
                    </form>
                </div>

                <div class="p-6 border-t bg-gray-50 flex justify-end">
                    <button type="submit" form="task-type-form"
                        class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold shadow hover:bg-blue-700 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4">
                            </path>
                        </svg>
                        Guardar Configuraci칩n
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initTaskConfig } from './js/modules/taskConfig.js?v=2.15';
        import { checkSession, logout, fetchAPI } from './api.js?v=2.15';
        import { initBadgeMonitor } from './js/modules/badgeMonitor.js?v=2.15';
        import { initIncidentsAdmin } from './js/modules/incidentsAdmin.js?v=2.15';
        import { initActivityAdmin } from './js/modules/activityAdmin.js?v=3.3';
        import { initHistoryViewer } from './js/modules/historyViewer.js?v=2.15';

        // --- State Variables ---
        let fullKpiResults = null;
        let ingresoPotencialBase = 0;

        // --- Helper Functions ---
        function formatCurrency(value) {
            return `$${(Math.round(value) || 0).toLocaleString('es-CL')}`;
        }

        function updateProjectedValues(proyeccion) {
            if (!fullKpiResults) return;
            const nuevoIngresoProyectado = ingresoPotencialBase * (proyeccion / 100);
            const ingresoProyectadoEl = document.getElementById('ingreso-proyectado-valor');
            if (ingresoProyectadoEl) ingresoProyectadoEl.textContent = formatCurrency(nuevoIngresoProyectado);

            fullKpiResults.rankingCaba침as.forEach((caba침a, index) => {
                const nochesDisponiblesProyectadas = caba침a.nochesDisponibles * (proyeccion / 100);
                const nochesFaltantesProyectadas = Math.max(0, nochesDisponiblesProyectadas - caba침a.nochesOcupadas);
                const row = document.getElementById(`ranking-row-${index}`);
                if (row) {
                    const cell = row.querySelector('.noches-faltantes-cell');
                    if (cell) cell.textContent = Math.round(nochesFaltantesProyectadas);
                }
            });
        }

        function displayKPIs(results) {
            fullKpiResults = results;
            const { kpisGenerales } = results;
            ingresoPotencialBase = kpisGenerales.ingresoPotencialTotalBase || 0;
            const proyeccionActual = parseInt(document.getElementById('kpi-proyeccion-slider').value);
            const ingresoProyectadoActual = ingresoPotencialBase * (proyeccionActual / 100);
            const kpiCardsContainer = document.getElementById('kpi-cards');
            kpiCardsContainer.innerHTML = `
                                <div class="p-4 bg-gray-100 rounded-lg"><div class="text-sm font-medium text-gray-500">Ocupaci칩n</div><div class="text-2xl font-bold text-gray-900">${kpisGenerales.tasaOcupacion}%</div></div>
                                <div class="p-4 bg-gray-100 rounded-lg"><div class="text-sm font-medium text-gray-500">ADR</div><div class="text-2xl font-bold text-gray-900">${formatCurrency(kpisGenerales.adr)}</div></div>
                                <div class="p-4 bg-gray-100 rounded-lg"><div class="text-sm font-medium text-gray-500">RevPAR</div><div class="text-2xl font-bold text-gray-900">${formatCurrency(kpisGenerales.revPar)}</div></div>
                                <div class="p-4 bg-green-100 rounded-lg"><div class="text-sm font-medium text-green-700">Ingreso Real</div><div class="text-2xl font-bold text-green-900">${formatCurrency(kpisGenerales.ingresoTotal)}</div></div>
                                <div class="p-4 bg-blue-100 rounded-lg"><div id="ingreso-proyectado-valor" class="text-sm font-medium text-blue-700">Ingreso Proyectado</div><div class="text-2xl font-bold text-blue-900">${formatCurrency(ingresoProyectadoActual)}</div></div>
                                <div class="p-4 bg-red-100 rounded-lg"><div class="text-sm font-medium text-red-700">Descuento Real</div><div class="text-2xl font-bold text-red-900">${formatCurrency(kpisGenerales.descuentosTotalesReales)}</div></div>`;

            const canalDetailsTable = document.getElementById('canal-details-table');
            canalDetailsTable.innerHTML = `
                                <table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Canal</th><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase"># Reservas</th><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Ingreso Real</th></tr></thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${Object.entries(kpisGenerales.reservasPorCanal).map(([canal, data]) => `<tr><td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${canal}</td><td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${data.count}</td><td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${formatCurrency(data.ingreso)}</td></tr>`).join('')}
                                </tbody></table>`;

            const rankingTableBody = document.getElementById('ranking-table-body');
            rankingTableBody.innerHTML = '';
            results.rankingCaba침as.forEach((caba침a, index) => {
                const row = document.createElement('tr');
                row.id = `ranking-row-${index}`;
                row.setAttribute('data-caba침a-nombre', caba침a.nombre);
                const nochesDisponiblesProyectadas = caba침a.nochesDisponibles * (proyeccionActual / 100);
                const nochesFaltantesProyectadas = Math.max(0, nochesDisponiblesProyectadas - caba침a.nochesOcupadas);
                row.innerHTML = `<td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${caba침a.nombre}</td><td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${caba침a.nochesOcupadas}</td><td class="noches-faltantes-cell px-4 py-3 whitespace-nowrap text-sm text-gray-700">${Math.round(nochesFaltantesProyectadas)}</td><td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${formatCurrency(caba침a.ingresoRealTotal)}</td><td class="px-4 py-3 whitespace-nowrap text-sm text-red-600">${formatCurrency(caba침a.descuentoTotal)}</td>`;
                rankingTableBody.appendChild(row);
            });
        }

        function showDetailModal(caba침aNombre) {
            const caba침aData = fullKpiResults.rankingCaba침as.find(c => c.nombre === caba침aNombre);
            if (!caba침aData) return;
            const modal = document.getElementById('detail-modal');
            const title = document.getElementById('detail-modal-title');
            const content = document.getElementById('detail-modal-content');
            title.textContent = `Detalle por Canal - ${caba침aNombre}`;
            let tableHtml = `<p class="text-sm text-center text-gray-500">No hay datos de descuentos por canal para esta caba침a.</p>`;
            if (caba침aData.canales && Object.keys(caba침aData.canales).length > 0) {
                tableHtml = `<table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Canal</th><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Noches con Descuento</th><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Descuento Total</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">${Object.entries(caba침aData.canales).map(([canal, data]) => `<tr><td class="px-4 py-2 text-sm font-medium">${canal}</td><td class="px-4 py-2 text-sm">${data.noches}</td><td class="px-4 py-2 text-sm text-red-600">${formatCurrency(data.descuento)}</td></tr>`).join('')}</tbody></table>`;
            }
            content.innerHTML = tableHtml;
            modal.classList.remove('hidden');
        }

        // --- Main Init ---
        document.addEventListener('DOMContentLoaded', async () => {
            const loader = document.getElementById('loader');
            const appContent = document.getElementById('app-content');
            const authInfo = document.getElementById('auth-info');

            const session = checkSession();
            if (!session) return;

            // Force visible
            if (loader) loader.style.display = 'none';
            if (appContent) appContent.classList.remove('hidden');

            if (authInfo) {
                authInfo.innerHTML = `<span class="text-sm text-gray-600 hidden sm:block">${session.userEmail}</span><button id="logout-btn" class="px-3 py-2 bg-red-600 text-white text-xs font-medium rounded-md hover:bg-red-700">Cerrar Sesi칩n</button>`;
                document.getElementById('logout-btn').addEventListener('click', logout);
            }

            // Safe Module Init
            try { initTaskConfig(); } catch (e) { console.error('TaskConfig:', e); }
            try { initBadgeMonitor(); } catch (e) { console.error('BadgeMonitor:', e); }
            try { initIncidentsAdmin(); } catch (e) { console.error('IncidentsAdmin:', e); }
            try { initActivityAdmin(); } catch (e) { console.error('ActivityAdmin:', e); } // New
            try { initHistoryViewer(); } catch (e) { console.error('HistoryViewer:', e); }

            // Load Async Data
            loadSettingsHeader();
            loadPendingTasksCount();

            // Bind Events
            bindDashboardEvents();
        });

        async function loadSettingsHeader() {
            try {
                const settings = await fetchAPI('/api/settings/empresa');
                if (settings.nombreEmpresa) document.querySelector('h1.text-xl').textContent = settings.nombreEmpresa;
            } catch (e) { console.error('Error header settings:', e); }
        }

        async function loadPendingTasksCount() {
            try {
                const pendingTasks = await fetchAPI('/api/gestion/pendientes');
                const badge = document.getElementById('gestion-badge');
                if (badge && pendingTasks.length > 0) {
                    badge.textContent = pendingTasks.length;
                    badge.classList.remove('hidden');
                }
            } catch (e) { console.error("Error pending tasks:", e); }
        }

        function bindDashboardEvents() {
            const calculateBtn = document.getElementById('kpi-calculate-btn');
            const repairBtn = document.getElementById('repair-btn');
            const repairPhonesBtn = document.getElementById('repair-phones-btn');
            const proyeccionSlider = document.getElementById('kpi-proyeccion-slider');
            const rankingTableBody = document.getElementById('ranking-table-body');
            const detailModalCloseBtn = document.getElementById('detail-modal-close-btn');
            const warningContainer = document.getElementById('kpi-warning-container');
            const repairStatus = document.getElementById('repair-status');
            const repairPhonesStatus = document.getElementById('repair-phones-status');
            const detailModal = document.getElementById('detail-modal');

            // KPIs
            if (calculateBtn) calculateBtn.addEventListener('click', async () => {
                const fechaInicio = document.getElementById('kpi-fecha-inicio').value;
                const fechaFin = document.getElementById('kpi-fecha-fin').value;
                const resultsContainer = document.getElementById('kpi-results-container');
                const loadingIndicator = document.getElementById('kpi-loading');

                if (!fechaInicio || !fechaFin) { alert('Selecciona fechas.'); return; }

                loadingIndicator.classList.remove('hidden');
                resultsContainer.classList.add('hidden');
                if (warningContainer) warningContainer.classList.add('hidden');

                try {
                    const results = await fetchAPI(`/api/kpi?fechaInicio=${fechaInicio}&fechaFin=${fechaFin}`);
                    if (results.warning && warningContainer) {
                        warningContainer.textContent = results.warning;
                        warningContainer.classList.remove('hidden');
                    }
                    displayKPIs(results);
                    resultsContainer.classList.remove('hidden');
                } catch (e) { alert(e.message); }
                finally { loadingIndicator.classList.add('hidden'); }
            });

            if (proyeccionSlider) proyeccionSlider.addEventListener('input', (e) => {
                document.getElementById('proyeccion-valor').textContent = e.target.value;
                updateProjectedValues(parseInt(e.target.value));
            });

            if (rankingTableBody) rankingTableBody.addEventListener('click', (e) => {
                const row = e.target.closest('tr');
                if (row && row.dataset.caba침aNombre) showDetailModal(row.dataset.caba침aNombre);
            });

            if (detailModalCloseBtn) detailModalCloseBtn.addEventListener('click', () => {
                if (detailModal) detailModal.classList.add('hidden');
            });

            // Repairs
            if (repairBtn) repairBtn.addEventListener('click', async () => {
                if (!confirm('Esta acci칩n revisar치 todas las reservas y reparar치 las que no tengan un estado de gesti칩n. 쮻eseas continuar?')) return;
                repairBtn.disabled = true;
                repairBtn.textContent = 'Reparando...';
                if (repairStatus) {
                    repairStatus.classList.remove('hidden');
                    repairStatus.textContent = 'Iniciando proceso...';
                }
                try {
                    const result = await fetchAPI('/api/gestion/fix-missing-states', { method: 'POST' });
                    if (repairStatus) repairStatus.innerHTML = `<strong>칄xito:</strong> ${result.message}`;
                } catch (error) {
                    if (repairStatus) repairStatus.innerHTML = `<strong>Error:</strong> ${error.message}`;
                } finally {
                    repairBtn.disabled = false;
                    repairBtn.textContent = 'Reparar Estados de Reservas Antiguas';
                }
            });

            if (repairPhonesBtn) repairPhonesBtn.addEventListener('click', async () => {
                if (!confirm('Esta acci칩n revisar치 todas las reservas y reparar치 las que no tengan un n칰mero de tel칠fono. 쮻eseas continuar?')) return;
                repairPhonesBtn.disabled = true;
                repairPhonesBtn.textContent = 'Reparando...';
                if (repairPhonesStatus) {
                    repairPhonesStatus.classList.remove('hidden');
                    repairPhonesStatus.textContent = 'Iniciando reparaci칩n...';
                }
                try {
                    const result = await fetchAPI('/api/gestion/fix-missing-phones', { method: 'POST' });
                    if (repairPhonesStatus) repairPhonesStatus.innerHTML = `<strong>칄xito:</strong> ${result.message}`;
                } catch (error) {
                    if (repairPhonesStatus) repairPhonesStatus.innerHTML = `<strong>Error:</strong> ${error.message}`;
                } finally {
                    repairPhonesBtn.disabled = false;
                    repairPhonesBtn.textContent = 'Reparar Tel칠fonos Faltantes';
                }
            });

            // Settings Modal Logic
            const settingsForm = document.getElementById('settings-form');
            const settingsStatus = document.getElementById('settings-status');

            if (settingsForm) settingsForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (settingsStatus) {
                    settingsStatus.textContent = 'Guardando...';
                    settingsStatus.classList.remove('hidden', 'text-green-600', 'text-red-600');
                }

                const data = {
                    nombreEmpresa: document.getElementById('nombreEmpresa')?.value,
                    adminNombre: document.getElementById('adminNombre')?.value,
                    adminEmail: document.getElementById('adminEmail')?.value,
                    telefonoContacto: document.getElementById('telefonoContacto')?.value,
                    telegramChatId: document.getElementById('telegramChatId')?.value,
                    workerChatId: document.getElementById('workerChatId')?.value,
                    botToken: document.getElementById('botToken')?.value,
                };

                try {
                    await fetchAPI('/api/settings/empresa', { method: 'PUT', body: data });
                    if (settingsStatus) {
                        settingsStatus.textContent = 'Guardado correctamente.';
                        settingsStatus.classList.add('text-green-600');
                        setTimeout(() => settingsStatus.classList.add('hidden'), 3000);
                    }
                } catch (error) {
                    if (settingsStatus) {
                        settingsStatus.textContent = 'Error al guardar.';
                        settingsStatus.classList.add('text-red-600');
                    }
                }
            });

            async function loadSettingsForm() {
                try {
                    const s = await fetchAPI('/api/settings/empresa');
                    if (document.getElementById('nombreEmpresa')) document.getElementById('nombreEmpresa').value = s.nombreEmpresa || '';
                    if (document.getElementById('adminNombre')) document.getElementById('adminNombre').value = s.adminNombre || '';
                    if (document.getElementById('adminEmail')) document.getElementById('adminEmail').value = s.adminEmail || '';
                    if (document.getElementById('telefonoContacto')) document.getElementById('telefonoContacto').value = s.telefonoContacto || '';
                    if (document.getElementById('telegramChatId')) document.getElementById('telegramChatId').value = s.telegramChatId || '';
                    if (document.getElementById('workerChatId')) document.getElementById('workerChatId').value = s.workerChatId || '';
                    if (document.getElementById('botToken')) document.getElementById('botToken').value = s.botToken || '';
                } catch (e) { }
            }
            loadSettingsForm();

            // Toggle Modals
            const bindModal = (btnId, modalId, closeId) => {
                const btn = document.getElementById(btnId);
                const modal = document.getElementById(modalId);
                const close = document.getElementById(closeId);
                if (btn) btn.addEventListener('click', () => modal.classList.remove('hidden'));
                if (close) close.addEventListener('click', () => modal.classList.add('hidden'));
            };
            bindModal('abrir-historial-btn', 'modal-historial', 'cerrar-historial-btn');
            bindModal('abrir-settings-btn', 'modal-settings', 'cerrar-settings-btn');
        }
    </script>
    <!-- Incidents Admin Modal -->
    <div id="admin-incidents-modal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title"
        role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div
                class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">Gesti칩n de Incidencias</h3>
                        <button id="close-admin-incidents" type="button"
                            class="bg-white rounded-md text-gray-400 hover:text-gray-500 focus:outline-none">
                            <span class="sr-only">Cerrar</span>
                            <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <div id="admin-incidents-list" class="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                        <p class="text-center text-gray-500">Cargando...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Activities Admin Modal -->
    <div id="admin-activities-modal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title"
        role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div
                class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="flex justify-between items-center mb-4">
                        <!-- Header Navigation -->
                        <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                            <!-- Header Navigation -->
                            <div class="flex items-center gap-4 w-full sm:w-auto justify-between sm:justify-start">
                                <button id="act-back-btn"
                                    class="hidden p-2 hover:bg-gray-100 rounded-full text-gray-600">
                                    <span class="text-xl"></span>
                                </button>
                                <h3 id="act-title" class="text-lg sm:text-xl font-bold text-gray-900 truncate">Control
                                    Actividades</h3>
                                <button id="close-admin-activities-mobile" type="button"
                                    class="sm:hidden bg-white rounded-md text-gray-400 hover:text-gray-500 focus:outline-none">
                                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                            <div
                                class="flex items-center gap-2 w-full sm:w-auto justify-center sm:justify-end bg-gray-50 p-1 rounded-lg">
                                <button id="act-prev-month"
                                    class="p-2 hover:bg-white shadow-sm rounded text-gray-600 transition-colors">餃</button>
                                <span id="act-current-month"
                                    class="font-semibold text-gray-800 min-w-[120px] text-center text-sm sm:text-base">...</span>
                                <button id="act-next-month"
                                    class="p-2 hover:bg-white shadow-sm rounded text-gray-600 transition-colors">郊</button>

                                <button id="close-admin-activities" type="button"
                                    class="hidden sm:block ml-4 bg-white rounded-md text-gray-400 hover:text-gray-500 focus:outline-none">
                                    <span class="sr-only">Cerrar</span>
                                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>

                            <!-- Main Content Container -->
                            <div class="h-[70vh] overflow-y-auto pr-1 relative">

                                <!-- VIEW 1: Calendar Grid -->
                                <div id="act-view-calendar" class="w-full">
                                    <div
                                        class="grid grid-cols-7 gap-1 mb-2 text-center text-xs sm:text-sm font-semibold text-gray-500">
                                        <div>Dom</div>
                                        <div>Lun</div>
                                        <div>Mar</div>
                                        <div>Mi칠</div>
                                        <div>Jue</div>
                                        <div>Vie</div>
                                        <div>S치b</div>
                                    </div>
                                    <div id="act-calendar-grid" class="grid grid-cols-7 gap-1 sm:gap-2">
                                        <!-- Days injected here -->
                                    </div>
                                </div>

                                <!-- VIEW 2: Day Detail (Cabin List) -->
                                <div id="act-view-day" class="hidden w-full space-y-4">
                                    <h4 class="text-lg font-semibold text-gray-700 border-b pb-2">Resumen por Caba침a
                                    </h4>
                                    <div id="act-day-list" class="space-y-3">
                                        <!-- Cabin rows injected here -->
                                    </div>
                                </div>

                                <!-- VIEW 3: Cabin Detail (Task List) -->
                                <div id="act-view-cabin" class="hidden w-full space-y-4">
                                    <div class="bg-blue-50 p-4 rounded-lg mb-4">
                                        <div class="flex flex-col sm:flex-row justify-between">
                                            <span class="font-bold text-blue-900 text-lg"
                                                id="act-detail-cabin-name">Caba침a
                                                X</span>
                                            <span class="text-blue-700 text-sm sm:text-base mt-1 sm:mt-0"
                                                id="act-detail-worker">Trabajador: ...</span>
                                        </div>
                                    </div>
                                    <div class="overflow-x-auto border rounded-lg shadow-sm">
                                        <table class="min-w-full divide-y divide-gray-200">
                                            <thead class="bg-gray-50">
                                                <tr>
                                                    <th
                                                        class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Tarea</th>
                                                    <th
                                                        class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Estado</th>
                                                    <th
                                                        class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Inicio</th>
                                                    <th
                                                        class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                        Fin</th>
                                                </tr>
                                            </thead>
                                            <tbody id="act-task-list" class="bg-white divide-y divide-gray-200">
                                                <!-- Tasks injected here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
</body>

</html>