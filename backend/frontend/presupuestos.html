<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generar Presupuesto - Gestor de Reservas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        #client-results-list>div:hover {
            background-color: #f0f4ff;
        }
    </style>
</head>

<body class="bg-gray-100">
    <div id="loader" class="text-center p-8">
        <p class="text-gray-500">Verificando sesi√≥n...</p>
    </div>

    <div id="app-content" class="min-h-screen hidden">
        <nav class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <a href="dashboard.html" class="text-xl font-bold text-gray-800">Gestor de Reservas</a>
                    <div id="auth-info" class="flex items-center space-x-4"></div>
                </div>
            </div>
        </nav>
        <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <div class="bg-white p-8 rounded-lg shadow space-y-8">
                <div>
                    <h2 class="text-2xl font-semibold text-gray-900 mb-4">Generador de Presupuestos</h2>

                    <div class="p-4 border rounded-md bg-gray-50 mb-6">
                        <h3 class="font-semibold text-gray-800 mb-2">1. Datos del Cliente</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="client-search" class="block text-sm font-medium text-gray-700">Buscar
                                    cliente existente</label>
                                <input type="text" id="client-search" placeholder="Escribe para buscar..."
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                <div id="client-results-list"
                                    class="mt-1 border rounded-md max-h-32 overflow-y-auto bg-white"></div>
                            </div>
                            <div id="new-client-fields" class="space-y-2">
                                <p id="client-form-title" class="text-sm font-medium text-gray-700">... o a√±ade un
                                    cliente nuevo</p>
                                <input type="text" id="new-client-name" placeholder="Nombre completo"
                                    class="block w-full rounded-md border-gray-300 shadow-sm">
                                <input type="text" id="new-client-company" placeholder="Empresa (Opcional)"
                                    class="block w-full rounded-md border-gray-300 shadow-sm">
                                <input type="tel" id="new-client-phone" placeholder="Tel√©fono (Opcional)"
                                    class="block w-full rounded-md border-gray-300 shadow-sm">
                                <input type="email" id="new-client-email" placeholder="Email(s) separados por ;"
                                    class="block w-full rounded-md border-gray-300 shadow-sm">
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-col md:flex-row items-end space-y-4 md:space-y-0 md:space-x-4 pb-6 border-b">
                        <div>
                            <h3 class="font-semibold text-gray-800 mb-2">2. Fechas y Personas</h3>
                            <label for="fecha-llegada" class="block text-sm font-medium text-gray-700">Fecha de
                                Llegada</label>
                            <input type="date" id="fecha-llegada"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                        <div>
                            <label for="fecha-salida" class="block text-sm font-medium text-gray-700">Fecha de
                                Salida</label>
                            <input type="date" id="fecha-salida"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                        <div>
                            <label for="personas" class="block text-sm font-medium text-gray-700">N¬∞ de Personas</label>
                            <input type="number" id="personas"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                        <div class="flex items-center pt-6 space-x-4">
                            <div class="flex items-center">
                                <input id="sin-camarotes-checkbox" type="checkbox"
                                    class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
                                <label for="sin-camarotes-checkbox"
                                    class="ml-2 block text-sm font-medium text-gray-700">Sin Camarotes</label>
                            </div>
                            <div class="flex items-center">
                                <input id="permitir-cambios-checkbox" type="checkbox"
                                    class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
                                <label for="permitir-cambios-checkbox"
                                    class="ml-2 block text-sm font-medium text-gray-700">Permitir Cambios
                                    (Itinerancia)</label>
                            </div>
                        </div>
                        <button id="generar-btn"
                            class="w-full md:w-auto bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700">
                            Generar Propuesta
                        </button>
                    </div>
                </div>

                <div id="status-container" class="text-center text-gray-500 hidden p-4"></div>

                <div id="results-container" class="hidden grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">3. Propuesta y Modificaci√≥n de Caba√±as</h3>
                            <div id="suggestion-list" class="mt-2 space-y-2"></div>
                        </div>
                        <div>
                            <h4 class="text-md font-medium text-gray-700">Otras Caba√±as Disponibles</h4>
                            <div id="available-list" class="mt-2 space-y-2"></div>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-gray-800">4. Presupuesto Final</h3>
                        <textarea id="presupuesto-texto" rows="25"
                            class="w-full p-2 border border-gray-300 rounded-md shadow-sm bg-gray-50 font-mono text-xs"></textarea>
                        <div class="flex space-x-2">
                            <button id="copy-btn"
                                class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md text-sm font-medium hover:bg-gray-300">Copiar</button>
                            <button id="save-btn"
                                class="bg-green-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-green-700">Guardar</button>
                            <button id="email-btn"
                                class="bg-blue-500 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-blue-600">Enviar
                                por Email</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { checkSession, logout, fetchAPI } from './api.js';

        document.addEventListener('DOMContentLoaded', () => {

            const loader = document.getElementById('loader');
            const appContent = document.getElementById('app-content');
            const authInfo = document.getElementById('auth-info');
            const fechaLlegadaInput = document.getElementById('fecha-llegada');
            const fechaSalidaInput = document.getElementById('fecha-salida');
            const generarBtn = document.getElementById('generar-btn');
            const statusContainer = document.getElementById('status-container');
            const resultsContainer = document.getElementById('results-container');
            const suggestionList = document.getElementById('suggestion-list');
            const availableList = document.getElementById('available-list');
            const presupuestoTexto = document.getElementById('presupuesto-texto');
            const copyBtn = document.getElementById('copy-btn');
            const saveBtn = document.getElementById('save-btn');
            const emailBtn = document.getElementById('email-btn');
            const clientSearchInput = document.getElementById('client-search');
            const clientResultsList = document.getElementById('client-results-list');
            const newClientNameInput = document.getElementById('new-client-name');
            const newClientCompanyInput = document.getElementById('new-client-company');
            const newClientPhoneInput = document.getElementById('new-client-phone');
            const newClientEmailInput = document.getElementById('new-client-email');
            const clientFormTitle = document.getElementById('client-form-title');
            const sinCamarotesCheckbox = document.getElementById('sin-camarotes-checkbox');
            const permitirCambiosCheckbox = document.getElementById('permitir-cambios-checkbox');

            let allClients = [];
            let selectedClient = null;
            let fullData = {};
            let selectedCabanas = [];
            let currentPricing = {};

            function formatCurrency(value) { return `$${(value || 0).toLocaleString('es-CL')}`; }

            function createCabanaCheckbox(item, isSuggested, isSegmented = false) {
                const cabana = isSegmented ? item.cabana : item;
                const div = document.createElement('div');
                div.className = 'p-2 border rounded-md flex items-center justify-between bg-white';

                const effectiveCapacity = sinCamarotesCheckbox.checked
                    ? ((cabana.camas?.matrimoniales || 0) * 2) + (cabana.camas?.plazaYMedia || 0) + (cabana.camas?.camarotes || 0)
                    : cabana.capacidad;

                let labelText = cabana.nombre;
                let subText = `(Cap: ${effectiveCapacity})`;
                let dateText = '';

                if (isSegmented && item.startDate && item.endDate) {
                    const start = new Date(item.startDate);
                    const end = new Date(item.endDate);
                    // Adjust if coming from string
                    const s = start.toISOString().split('T')[0];
                    const e = end.toISOString().split('T')[0];
                    dateText = `<div class="text-xs text-blue-600 font-medium">Desde ${s} hasta ${e}</div>`;
                }

                div.innerHTML = `
                <div class="flex-1">
                    <div class="flex items-center">
                        <input type="checkbox" id="cb-${isSegmented ? 'seg-' + Math.random().toString(36).substr(2, 9) : cabana.id}" 
                               data-id="${cabana.id}" 
                               class="cabana-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded" 
                               ${isSuggested ? 'checked' : ''}
                               ${isSegmented ? 'disabled' : ''}>
                        <label class="ml-2 font-medium text-gray-900">${labelText}</label>
                        <span class="ml-2 text-sm text-gray-500">${subText}</span>
                    </div>
                    ${dateText}
                </div>`;
                return div;
            }

            function renderSelectionUI() {
                suggestionList.innerHTML = '';
                availableList.innerHTML = '';
                if (!fullData.suggestion) return;

                const isSegmented = fullData.suggestion.isSegmented;

                // Render Suggested
                fullData.suggestion.cabanas.forEach(c => {
                    suggestionList.appendChild(createCabanaCheckbox(c, true, isSegmented));
                });

                // Render Available (only if not segmented, or complex logic needed)
                // For segmented, "Available" might mean "Other cabins that could be used"? 
                // But availability is per day.
                // We will hide "Available" list for segmented to avoid confusion, or just show them as "Standard options" which likely failed?
                if (!isSegmented) {
                    const suggestedIds = new Set(fullData.suggestion.cabanas.map(c => c.id));
                    fullData.availableCabanas.forEach(c => {
                        if (!suggestedIds.has(c.id)) {
                            availableList.appendChild(createCabanaCheckbox(c, false, false));
                        }
                    });
                    document.querySelectorAll('.cabana-checkbox').forEach(cb => cb.addEventListener('change', handleSelectionChange));
                } else {
                    availableList.innerHTML = '<p class="text-sm text-gray-500 italic">En modo itinerancia, solo se muestra la combinaci√≥n sugerida.</p>';
                }

                generatePresupuestoText(fullData.suggestion.pricing);
            }

            async function handleSelectionChange() {
                // If segmented, this shouldn't be called because checkboxes are disabled
                const selectedIds = new Set(Array.from(document.querySelectorAll('.cabana-checkbox:checked')).map(cb => cb.dataset.id));
                selectedCabanas = fullData.allCabanas.filter(c => selectedIds.has(c.id));

                if (selectedCabanas.length === 0) {
                    generatePresupuestoText({ totalPrice: 0, nights: 0, details: [] });
                    return;
                }
                try {
                    const payload = {
                        fechaLlegada: fechaLlegadaInput.value,
                        fechaSalida: fechaSalidaInput.value,
                        cabanas: selectedCabanas
                    };
                    const newPricing = await fetchAPI('/api/presupuestos/recalcular', { method: 'POST', body: payload });
                    generatePresupuestoText(newPricing);
                } catch (error) {
                    presupuestoTexto.value = `Error al recalcular el precio: ${error.message}`;
                }
            }

            function generatePresupuestoText(pricing) {
                currentPricing = pricing;
                const fechaLlegada = new Date(fechaLlegadaInput.value + 'T00:00:00Z');
                const fechaSalida = new Date(fechaSalidaInput.value + 'T00:00:00Z');
                const hoy = new Date();
                let clientName = selectedClient ? selectedClient.nombre : newClientNameInput.value.trim();
                let clientCompany = selectedClient ? selectedClient.empresa : newClientCompanyInput.value.trim();
                const dirigidoA = clientCompany ? `${clientName} ‚Äì ${clientCompany}` : clientName;
                const noches = pricing.nights || 0;
                const dias = noches + 1;

                let texto = `üìå Presupuesto de Alojamiento ‚Äì Orillas del Coilaco\n`;
                texto += `Turismo & Naturaleza\n\n`;
                texto += `Dirigido a: ${dirigidoA}\n`;
                texto += `Fecha de emisi√≥n: ${hoy.toLocaleDateString('es-CL')}\n`;
                texto += `Grupo solicitado: ${document.getElementById('personas').value} personas\n`;
                texto += `Estad√≠a: ${fechaLlegada.toLocaleDateString('es-CL', { timeZone: 'UTC' })} al ${fechaSalida.toLocaleDateString('es-CL', { timeZone: 'UTC' })} (${dias} d√≠as / ${noches} noches)\n`;

                if (sinCamarotesCheckbox.checked) {
                    texto += `Nota: La selecci√≥n de caba√±as se ha ajustado para no utilizar las literas superiores de los camarotes, considerando solo una persona por camarote.\n`;
                }

                texto += `\nüè° Detalle de Caba√±as Asignadas\n`;
                if (pricing.details && pricing.details.length > 0) {
                    pricing.details.forEach(detail => {
                        const cabanaInfo = fullData.allCabanas.find(c => c.nombre === detail.nombre);
                        const capacidadTexto = sinCamarotesCheckbox.checked ? `(Capacidad ajustada: ${(cabanaInfo.camas?.matrimoniales || 0) * 2 + (cabanaInfo.camas?.plazaYMedia || 0) + (cabanaInfo.camas?.camarotes || 0)} personas)` : `(Capacidad: ${cabanaInfo.capacidad} personas)`;
                        texto += `\nüîπ ${cabanaInfo.nombre} ${capacidadTexto}\n`;
                        if (cabanaInfo.descripcion) texto += `${cabanaInfo.descripcion}\n`;
                        if (cabanaInfo.linkFotos) texto += `üì∑ Ver fotos: ${cabanaInfo.linkFotos}\n`;
                        texto += `üíµ Valor por noche: ${formatCurrency(detail.precioPorNoche)}\n`;
                        texto += `üíµ Total por ${noches} noches: ${formatCurrency(detail.precioTotal)}\n`;
                    });
                } else {
                    texto += `\nNinguna caba√±a seleccionada.\n`;
                }

                texto += `\n‚úÖ Servicios e instalaciones incluidas\n`;
                texto += `Tinaja en cada caba√±a, Piscina, Gimnasio, Zona de juegos, Quincho, Parrilla en cada caba√±a, Una hect√°rea de √°reas verdes.\n`;
                texto += `Juego de toallas por cada ba√±o (se recomienda traer una toalla extra por persona).\n`;

                texto += `\nüìä Resumen del Presupuesto\n`;
                texto += `Cantidad de caba√±as: ${selectedCabanas.length}\n`;
                const capacidadTotalCalculada = sinCamarotesCheckbox.checked
                    ? selectedCabanas.reduce((acc, c) => acc + ((c.camas?.matrimoniales || 0) * 2) + (c.camas?.plazaYMedia || 0) + (c.camas?.camarotes || 0), 0)
                    : selectedCabanas.reduce((acc, c) => acc + c.capacidad, 0);
                texto += `Capacidad total: ${capacidadTotalCalculada} personas\n`;
                texto += `Duraci√≥n estad√≠a: ${dias} d√≠as / ${noches} noches\n`;
                texto += `Valor total: ${formatCurrency(pricing.totalPrice)} (IVA incluido)\n\n`;

                texto += `üíµ Condiciones de Reserva\n`;
                texto += `Para confirmar la reserva se solicita un 10% de abono dentro de las 72 horas posteriores a la recepci√≥n de este presupuesto.\n`;
                texto += `El saldo restante (90%) debe ser cancelado al momento del check-in.\n`;
                texto += `Este presupuesto est√° sujeto a cambios seg√∫n disponibilidad y demanda al momento de la confirmaci√≥n.\n\n`;

                texto += `üìç Ubicaci√≥n\n`;
                texto += `Orillas del Coilaco, a minutos de Puc√≥n, Regi√≥n de la Araucan√≠a.\n`;
                texto += `üìç Ver en Google Maps: http://googleusercontent.com/maps/google.com/12\n\n`;

                texto += `‚úçÔ∏è Atentamente,\nPablo Meza\n`;
                texto += `üìß reservas@orillasdelcoilaco.cl\n`;
                texto += `üì± +56 9 7518 0855\n`;
                texto += `üåê www.orillasdelcoilaco.cl`;
                presupuestoTexto.value = texto;
            }

            async function loadClients() {
                try {
                    allClients = await fetchAPI('/api/clientes/simplificado');
                } catch (error) { console.error("No se pudieron cargar los clientes:", error); }
            }

            function filterClients() {
                const searchTerm = clientSearchInput.value.toLowerCase();
                clientResultsList.innerHTML = '';
                if (!searchTerm) {
                    clearClientSelection();
                    return;
                };
                const filtered = allClients.filter(c => c.nombre.toLowerCase().includes(searchTerm) || c.telefono.includes(searchTerm));
                filtered.slice(0, 5).forEach(client => {
                    const div = document.createElement('div');
                    div.className = 'p-2 cursor-pointer';
                    div.textContent = `${client.nombre} (${client.telefono})`;
                    div.onclick = () => selectClient(client);
                    clientResultsList.appendChild(div);
                });
            }

            function selectClient(client) {
                selectedClient = client;
                clientFormTitle.textContent = '... o actualiza los datos del cliente';
                clientSearchInput.value = client.nombre;
                clientResultsList.innerHTML = '';
                newClientNameInput.value = client.nombre || '';
                newClientCompanyInput.value = client.empresa || '';
                newClientPhoneInput.value = client.telefono || '';
                newClientEmailInput.value = client.email || '';
                [newClientNameInput, newClientCompanyInput, newClientPhoneInput, newClientEmailInput].forEach(el => el.disabled = false);
            }

            function clearClientSelection() {
                selectedClient = null;
                clientFormTitle.textContent = '... o a√±ade un cliente nuevo';
                [newClientNameInput, newClientCompanyInput, newClientPhoneInput, newClientEmailInput].forEach(el => {
                    el.value = '';
                    el.disabled = false;
                });
            }

            const session = checkSession();
            // const session = { userEmail: 'test@local' }; // Bypass login for testing
            if (session) {
                loader.style.display = 'none';
                appContent.classList.remove('hidden');
                authInfo.innerHTML = `
                <span class="text-sm text-gray-600 hidden sm:block">${session.userEmail}</span>
                <button id="logout-btn" class="px-3 py-2 bg-red-600 text-white text-xs font-medium rounded-md hover:bg-red-700">Cerrar Sesi√≥n</button>`;
                document.getElementById('logout-btn').addEventListener('click', logout);

                loadClients();
                fechaLlegadaInput.addEventListener('change', () => {
                    if (fechaLlegadaInput.value) {
                        const llegada = new Date(fechaLlegadaInput.value + "T00:00:00Z");
                        llegada.setDate(llegada.getDate() + 1);
                        fechaSalidaInput.min = llegada.toISOString().split('T')[0];
                        if (fechaSalidaInput.value && fechaSalidaInput.value <= fechaLlegadaInput.value) {
                            llegada.setDate(llegada.getDate() + 1);
                            fechaSalidaInput.value = llegada.toISOString().split('T')[0];
                        }
                    }
                });
                clientSearchInput.addEventListener('input', filterClients);

                generarBtn.addEventListener('click', async () => {
                    const payload = {
                        fechaLlegada: fechaLlegadaInput.value,
                        fechaSalida: fechaSalidaInput.value,
                        personas: document.getElementById('personas').value,
                        sinCamarotes: sinCamarotesCheckbox.checked,
                        permitirCambios: permitirCambiosCheckbox.checked
                    };
                    if (!payload.fechaLlegada || !payload.fechaSalida || !payload.personas || (!selectedClient && !newClientNameInput.value)) {
                        alert('Por favor, completa los datos del cliente, fechas y cantidad de personas.');
                        return;
                    }
                    generarBtn.disabled = true;
                    generarBtn.textContent = 'Generando...';
                    statusContainer.textContent = 'Buscando disponibilidad y calculando...';
                    statusContainer.classList.remove('hidden');
                    resultsContainer.classList.add('hidden');
                    try {
                        fullData = await fetchAPI('/api/presupuestos/generar', { method: 'POST', body: payload });
                        if (fullData.suggestion) {
                            statusContainer.classList.add('hidden');
                            resultsContainer.classList.remove('hidden');
                            renderSelectionUI();
                        } else {
                            statusContainer.textContent = fullData.message || 'No se pudo generar una propuesta.';
                        }
                    } catch (error) {
                        statusContainer.textContent = `Error: ${error.message}`;
                    } finally {
                        generarBtn.disabled = false;
                        generarBtn.textContent = 'Generar Propuesta';
                    }
                });

                copyBtn.addEventListener('click', () => {
                    navigator.clipboard.writeText(presupuestoTexto.value).then(() => {
                        const originalText = copyBtn.textContent;
                        copyBtn.textContent = '¬°Copiado!';
                        setTimeout(() => { copyBtn.textContent = originalText; }, 2000);
                    });
                });

                saveBtn.addEventListener('click', async () => {
                    let clienteParaGuardar;
                    if (selectedClient || newClientNameInput.value.trim()) {
                        clienteParaGuardar = {
                            id: selectedClient ? selectedClient.id : null,
                            nombre: newClientNameInput.value.trim(),
                            empresa: newClientCompanyInput.value.trim(),
                            telefono: newClientPhoneInput.value.trim(),
                            email: newClientEmailInput.value.trim(),
                        };
                    } else {
                        alert('Debes seleccionar o ingresar un cliente para guardar el presupuesto.');
                        return;
                    }
                    const presupuestoParaGuardar = {
                        fechaLlegada: fechaLlegadaInput.value,
                        fechaSalida: fechaSalidaInput.value,
                        personas: parseInt(document.getElementById('personas').value),
                        cabanasSeleccionadas: selectedCabanas,
                        valorTotal: currentPricing.totalPrice
                    };
                    saveBtn.disabled = true;
                    saveBtn.textContent = 'Guardando...';
                    try {
                        const result = await fetchAPI('/api/presupuestos/guardar', {
                            method: 'POST',
                            body: { cliente: clienteParaGuardar, presupuesto: presupuestoParaGuardar }
                        });
                        alert(`Presupuesto guardado con √©xito. ID: ${result.id}`);
                    } catch (error) {
                        alert(`Error al guardar el presupuesto: ${error.message}`);
                    } finally {
                        saveBtn.disabled = false;
                        saveBtn.textContent = 'Guardar Presupuesto';
                    }
                });

                emailBtn.addEventListener('click', () => {
                    const emails = newClientEmailInput.value.trim().replace(/;/g, ',');
                    if (!emails) {
                        alert('Por favor, ingresa al menos una direcci√≥n de correo electr√≥nico en el campo de email.');
                        return;
                    }
                    const subject = encodeURIComponent(`Presupuesto de Alojamiento - Orillas del Coilaco`);
                    const body = encodeURIComponent(presupuestoTexto.value);

                    const mailtoLink = document.createElement('a');
                    mailtoLink.href = `mailto:${emails}?subject=${subject}&body=${body}`;
                    mailtoLink.click();
                });
            }
        });
    </script>
</body>

</html>