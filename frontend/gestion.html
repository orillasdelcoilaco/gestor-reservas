<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión Diaria - Gestor de Reservas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        #gestion-modal, #bitacora-modal { background-color: rgba(0, 0, 0, 0.5); }
        .paste-zone { border: 2px dashed #ccc; padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .paste-zone.drag-over { background-color: #e0e7ff; border-color: #4f46e5; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="loader" class="text-center p-8"><p class="text-gray-500">Verificando sesión...</p></div>
    <div id="app-content" class="min-h-screen hidden">
        <nav class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center space-x-4">
                        <a href="dashboard.html" class="text-xl font-bold text-gray-800">Gestor de Reservas</a>
                        <a href="dashboard.html" class="hidden sm:block px-3 py-2 bg-gray-100 text-gray-700 text-sm font-medium rounded-md hover:bg-gray-200">Volver al Dashboard</a>
                    </div>
                    <div id="auth-info" class="flex items-center space-x-4"></div>
                </div>
            </div>
        </nav>
        <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <div class="bg-white p-6 md:p-8 rounded-lg shadow">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4">
                    <h2 class="text-2xl font-semibold text-gray-900">Panel de Gestión Diaria</h2>
                    <input type="text" id="search-input" placeholder="Buscar por nombre, reserva, teléfono..." class="mt-4 md:mt-0 w-full md:w-1/3 px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <div id="loading-state" class="text-center py-8"><p class="text-gray-500">Cargando tareas pendientes...</p></div>
                <div id="hoy-container" class="hidden"><h3 class="text-xl font-bold text-red-600 mb-4 border-b pb-2">Requiere Acción Hoy</h3><div id="hoy-list" class="space-y-4"></div></div>
                <div id="proximas-container" class="mt-8 hidden"><h3 class="text-xl font-semibold text-blue-600 mb-4 border-b pb-2">Próximas Llegadas</h3><div id="proximas-list" class="space-y-4"></div></div>
                <div id="no-pendientes" class="text-center py-12 hidden"><p class="text-2xl font-semibold text-green-600">¡Todo al día!</p><p class="text-gray-500 mt-2">No hay reservas con gestiones pendientes.</p></div>
            </div>
        </main>
    </div>

    <div id="gestion-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
            <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4" id="modal-title">Gestionar</h3>
            <div id="modal-content-container" class="space-y-4"></div>
            <button type="button" id="modal-cancel-btn" class="mt-4 w-full inline-flex justify-center rounded-md border border-gray-300 px-4 py-2 bg-white text-base font-medium text-gray-700 shadow-sm hover:bg-gray-50">Cerrar</button>
        </div>
    </div>

    <div id="bitacora-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl">
            <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4" id="bitacora-modal-title">Bitácora de Gestión</h3>
            <div id="bitacora-list" class="max-h-60 overflow-y-auto space-y-3 mb-4 pr-2"></div>
            <div class="border-t pt-4">
                <textarea id="bitacora-new-note" rows="3" class="w-full p-2 border rounded-md" placeholder="Añadir nueva nota..."></textarea>
                <div id="bitacora-status" class="text-sm mt-2"></div>
                <div class="mt-2 flex justify-end space-x-3">
                    <button type="button" id="bitacora-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md">Cerrar</button>
                    <button type="button" id="bitacora-save-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md">Guardar Nota</button>
                </div>
            </div>
        </div>
    </div>

<script type="module">
    import { checkSession, logout, fetchAPI } from './api.js';
    import { initializeHelpers, setCurrentGrupo, setAllTransacciones, renderAjusteTarifaModal, renderPagosModal, renderBoletaModal, renderGestionReservaModal } from './gestion-helpers.js';

    // --- Referencias a elementos del DOM ---
    const loader = document.getElementById('loader');
    const appContent = document.getElementById('app-content');
    const authInfo = document.getElementById('auth-info');
    const loadingState = document.getElementById('loading-state');
    const searchInput = document.getElementById('search-input');
    const hoyContainer = document.getElementById('hoy-container');
    const hoyList = document.getElementById('hoy-list');
    const proximasContainer = document.getElementById('proximas-container');
    const proximasList = document.getElementById('proximas-list');
    const noPendientes = document.getElementById('no-pendientes');
    const modal = document.getElementById('gestion-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalContent = document.getElementById('modal-content-container');
    const modalCancelBtn = document.getElementById('modal-cancel-btn');
    const bitacoraModal = document.getElementById('bitacora-modal');
    const bitacoraSaveBtn = document.getElementById('bitacora-save-btn');
    const bitacoraCancelBtn = document.getElementById('bitacora-cancel-btn');

    let allGrupos = [];
    let sessionUserEmail = '';

    // --- Inicialización del Módulo de Ayudantes ---
    initializeHelpers({
        modalContent,
        modal,
        bitacoraModal,
        loadGestion, // Pasamos la función para que los helpers puedan recargar
        getPagosElements: () => ({
            listaPagos: document.getElementById('lista-pagos'),
            pagosSummary: document.getElementById('pagos-summary'),
            pagosFormContainer: document.getElementById('pagos-form-container')
        })
    });

    function getStatusInfo(status) {
        switch (status) {
            case 'Pendiente Bienvenida': return { level: 1, text: 'PENDIENTE BIENVENIDA', color: 'bg-yellow-500' };
            case 'Pendiente Cobro': return { level: 2, text: 'PENDIENTE COBRO', color: 'bg-orange-500' };
            case 'Pendiente Pago': return { level: 3, text: 'PENDIENTE PAGO', color: 'bg-red-600' };
            case 'Pendiente Boleta': return { level: 4, text: 'PENDIENTE BOLETA', color: 'bg-purple-600' };
            default: return { level: 99, text: status ? status.toUpperCase() : 'DESCONOCIDO', color: 'bg-gray-400' };
        }
    }

    function createGrupoCard(grupo) {
        const card = document.createElement('div');
        card.className = 'p-4 border rounded-lg shadow-sm';
        const statusInfo = getStatusInfo(grupo.estadoGestion);
        const saldo = grupo.valorCLP - grupo.abono;

        let statusHtml;
        if (statusInfo.level <= 2) {
            const url = `mensajes.html?reservaId=${grupo.reservaIdOriginal}&accion=${statusInfo.level === 1 ? 'marcar_bienvenida_enviada' : 'marcar_cobro_enviado'}`;
            statusHtml = `<a href="${url}" class="text-sm font-bold text-white px-2 py-1 rounded ${statusInfo.color} hover:opacity-80">${statusInfo.text}</a>`;
        } else {
            statusHtml = `<span class="text-sm font-bold text-white px-2 py-1 rounded ${statusInfo.color}">${statusInfo.text}</span>`;
        }
        
        const revertButtonHtml = statusInfo.level > 1 ? `<button class="revert-btn ml-2 text-xl" title="Revertir estado">↩️</button>` : '';
        const kpiIcon = grupo.potencialCalculado ? '<span class="ml-1" title="Valor Potencial ya calculado">🧮</span>' : '';
        const clienteLink = `<a href="clientes.html?openModalFor=${grupo.clienteId}" target="_blank" class="ml-4 text-lg font-bold text-gray-800 hover:text-indigo-600">${grupo.clienteNombre}</a>`;
        
        card.innerHTML = `
            <div class="flex items-center mb-2">${statusHtml}${revertButtonHtml}${clienteLink}</div>
            <div class="text-sm text-gray-600 mt-2 grid grid-cols-2 md:grid-cols-4 gap-2">
                <p><strong>Teléfono:</strong> ${grupo.telefono || 'N/A'}</p>
                <p><strong>Cabañas (${grupo.reservasIndividuales.length}):</strong> ${grupo.reservasIndividuales.map(r => r.alojamiento).join(', ')}</p>
                <p><strong>Llegada:</strong> ${new Date(grupo.fechaLlegada).toLocaleDateString('es-CL', { timeZone: 'UTC' })}</p>
                <p><strong>ID Reserva:</strong> ${grupo.reservaIdOriginal}</p>
            </div>
            <div class="border-t mt-4 pt-3 flex flex-col md:flex-row justify-between items-center text-sm">
                <div class="grid grid-cols-3 gap-4 font-semibold text-center w-full md:w-2/3">
                    <div><span class="text-gray-500 font-medium">Total:</span> $${grupo.valorCLP.toLocaleString('es-CL')}</div>
                    <div class="text-green-600"><span class="text-gray-500 font-medium">Abonado:</span> $${grupo.abono.toLocaleString('es-CL')}</div>
                    <div class="text-red-600"><span class="text-gray-500 font-medium">Saldo:</span> $${saldo.toLocaleString('es-CL')}</div>
                </div>
                <div class="mt-3 md:mt-0 flex flex-wrap gap-2 justify-center">
                    <button data-gestion="bitacora" class="gestion-btn px-3 py-1 bg-gray-100 text-gray-800 text-xs font-semibold rounded-md hover:bg-gray-200">Bitácora 🗂️</button>
                    <button data-gestion="ajuste_tarifa" class="gestion-btn px-3 py-1 bg-yellow-100 text-yellow-800 text-xs font-semibold rounded-md hover:bg-yellow-200">Ajustar Tarifa ${kpiIcon}</button>
                    <button data-gestion="pagos" class="gestion-btn px-3 py-1 text-xs font-semibold rounded-md ${statusInfo.level >= 2 ? 'bg-green-100 text-green-800 hover:bg-green-200' : 'bg-gray-100 text-gray-400 cursor-not-allowed'}" ${statusInfo.level < 2 ? 'disabled' : ''}>Gestionar Pagos</button>
                    <button data-gestion="boleta" class="gestion-btn px-3 py-1 text-xs font-semibold rounded-md ${statusInfo.level >= 4 ? 'bg-purple-100 text-purple-800 hover:bg-purple-200' : 'bg-gray-100 text-gray-400 cursor-not-allowed'}" ${statusInfo.level < 4 ? 'disabled' : ''}>Gestionar Boleta</button>
                </div>
            </div>`;
        card.querySelectorAll('.gestion-btn').forEach(btn => btn.addEventListener('click', () => openManagementModal(btn.dataset.gestion, grupo)));
        if (revertButtonHtml) card.querySelector('.revert-btn').addEventListener('click', () => openRevertModal(grupo));
        return card;
    }

    function openManagementModal(type, grupo) {
        setCurrentGrupo(grupo);
        if (type === 'bitacora') {
            gestionUI.openBitacoraModal(grupo, sessionUserEmail);
            return;
        }
        modalTitle.textContent = `Gestionar ${type.replace('_', ' ')} (Reserva ${grupo.reservaIdOriginal})`;
        const actionMap = {
            'ajuste_tarifa': renderAjusteTarifaModal,
            'pagos': renderPagosModal,
            'boleta': renderBoletaModal,
            'gestionar_reserva': renderGestionReservaModal
        };
        if (actionMap[type]) {
            actionMap[type]();
            modal.classList.remove('hidden');
        }
    }

    async function loadGestion() {
        loadingState.style.display = 'block';
        [hoyContainer, proximasContainer, noPendientes].forEach(el => el.classList.add('hidden'));
        try {
            allGrupos = await fetchAPI('/api/gestion/pendientes');
            loadingState.style.display = 'none';
            updateFilteredView();
        } catch (error) {
            loadingState.innerHTML = `<p class="text-red-500 font-semibold">Error al cargar tareas: ${error.message}</p>`;
        }
    }

    function updateFilteredView() {
        const searchTerm = searchInput.value.toLowerCase();
        const filteredGrupos = allGrupos.filter(g => (g.clienteNombre && g.clienteNombre.toLowerCase().includes(searchTerm)) || (g.reservaIdOriginal && g.reservaIdOriginal.toLowerCase().includes(searchTerm)));
        hoyList.innerHTML = '';
        proximasList.innerHTML = '';
        if (filteredGrupos.length === 0) {
            noPendientes.classList.remove('hidden');
            return;
        }
        noPendientes.classList.add('hidden');
        const today = new Date(new Date().setUTCHours(0,0,0,0));
        const llegadasHoy = [], proximasLlegadas = [];
        filteredGrupos.forEach(grupo => (new Date(grupo.fechaLlegada).getTime() <= today.getTime() ? llegadasHoy : proximasLlegadas).push(grupo));
        
        if (llegadasHoy.length > 0) {
            llegadasHoy.forEach(g => hoyList.appendChild(createGrupoCard(g)));
            hoyContainer.classList.remove('hidden');
        }
        if (proximasLlegadas.length > 0) {
            proximasLlegadas.forEach(g => proximasList.appendChild(createGrupoCard(g)));
            proximasContainer.classList.remove('hidden');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const session = checkSession();
        if (session) {
            sessionUserEmail = session.userEmail;
            loader.style.display = 'none';
            appContent.classList.remove('hidden');
            authInfo.innerHTML = `<span class="text-sm text-gray-600 hidden sm:block">${sessionUserEmail}</span><button id="logout-btn" class="px-3 py-2 bg-red-600 text-white text-xs font-medium rounded-md hover:bg-red-700">Cerrar Sesión</button>`;
            document.getElementById('logout-btn').addEventListener('click', logout);
            
            searchInput.addEventListener('input', updateFilteredView);
            modalCancelBtn.addEventListener('click', () => modal.classList.add('hidden'));
            bitacoraCancelBtn.addEventListener('click', () => bitacoraModal.classList.add('hidden'));
            bitacoraSaveBtn.addEventListener('click', () => gestionUI.saveNote(sessionUserEmail));
            
            loadGestion();
        }
    });
</script>
</body>
</html>