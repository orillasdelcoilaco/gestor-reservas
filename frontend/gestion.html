<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión Diaria - Gestor de Reservas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        #gestion-modal { background-color: rgba(0, 0, 0, 0.5); }
        .paste-zone { border: 2px dashed #ccc; padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .paste-zone.drag-over { background-color: #e0e7ff; border-color: #4f46e5; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="loader" class="text-center p-8"><p class="text-gray-500">Verificando sesión...</p></div>
    <div id="app-content" class="min-h-screen hidden">
        <nav class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center space-x-4">
                        <a href="dashboard.html" class="text-xl font-bold text-gray-800">Gestor de Reservas</a>
                        <a href="dashboard.html" class="hidden sm:block px-3 py-2 bg-gray-100 text-gray-700 text-sm font-medium rounded-md hover:bg-gray-200">Volver al Dashboard</a>
                    </div>
                    <div id="auth-info" class="flex items-center space-x-4"></div>
                </div>
            </div>
        </nav>
        <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <div class="bg-white p-6 md:p-8 rounded-lg shadow">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4">
                    <h2 class="text-2xl font-semibold text-gray-900">Panel de Gestión Diaria</h2>
                    <input type="text" id="search-input" placeholder="Buscar por nombre, reserva, teléfono..." class="mt-4 md:mt-0 w-full md:w-1/3 px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <div id="loading-state" class="text-center py-8"><p class="text-gray-500">Cargando tareas pendientes...</p></div>
                <div id="hoy-container" class="hidden"><h3 class="text-xl font-bold text-red-600 mb-4 border-b pb-2">Requiere Acción Hoy</h3><div id="hoy-list" class="space-y-4"></div></div>
                <div id="proximas-container" class="mt-8 hidden"><h3 class="text-xl font-semibold text-blue-600 mb-4 border-b pb-2">Próximas Llegadas</h3><div id="proximas-list" class="space-y-4"></div></div>
                <div id="no-pendientes" class="text-center py-12 hidden"><p class="text-2xl font-semibold text-green-600">¡Todo al día!</p><p class="text-gray-500 mt-2">No hay reservas con gestiones pendientes.</p></div>
            </div>
        </main>
    </div>

    <div id="gestion-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
            <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4" id="modal-title">Gestionar</h3>
            <div id="modal-content-container" class="space-y-4"></div>
            <button type="button" id="modal-cancel-btn" class="mt-4 w-full inline-flex justify-center rounded-md border border-gray-300 px-4 py-2 bg-white text-base font-medium text-gray-700 shadow-sm hover:bg-gray-50">Cerrar</button>
        </div>
    </div>

<script type="module">
    import { checkSession, logout, fetchAPI } from './api.js';
    
    const loader = document.getElementById('loader');
    const appContent = document.getElementById('app-content');
    const authInfo = document.getElementById('auth-info');
    const loadingState = document.getElementById('loading-state');
    const searchInput = document.getElementById('search-input');
    const hoyContainer = document.getElementById('hoy-container');
    const hoyList = document.getElementById('hoy-list');
    const proximasContainer = document.getElementById('proximas-container');
    const proximasList = document.getElementById('proximas-list');
    const noPendientes = document.getElementById('no-pendientes');
    const modal = document.getElementById('gestion-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalContent = document.getElementById('modal-content-container');
    const modalCancelBtn = document.getElementById('modal-cancel-btn');

    let allGrupos = [];
    let currentGrupo = null;
    let currentAction = null;

    function formatCurrency(value) { return `$${(value || 0).toLocaleString('es-CL')}`; }
    function formatDate(dateString) { return dateString ? new Date(dateString).toLocaleDateString('es-CL', { timeZone: 'UTC' }) : 'N/A'; }
    
    function getStatusInfo(status) {
        switch (status) {
            case 'Pendiente Bienvenida': return { level: 1, text: 'PENDIENTE BIENVENIDA', color: 'bg-yellow-500' };
            case 'Pendiente Cobro': return { level: 2, text: 'PENDIENTE COBRO', color: 'bg-orange-500' };
            case 'Pendiente Pago': return { level: 3, text: 'PENDIENTE PAGO', color: 'bg-red-600' };
            case 'Pendiente Boleta': return { level: 4, text: 'PENDIENTE BOLETA', color: 'bg-purple-600' };
            default: return { level: 99, text: status ? status.toUpperCase() : 'DESCONOCIDO', color: 'bg-gray-400' };
        }
    }
    
    function createGrupoCard(grupo) {
        const card = document.createElement('div');
        card.className = 'p-4 border rounded-lg shadow-sm flex flex-col';
        const statusInfo = getStatusInfo(grupo.estadoGestion);
        const saldo = grupo.valorCLP - grupo.abono;
        const alojamientos = grupo.reservasIndividuales.map(r => r.alojamiento).join(', ');
        const isGestionPagosActive = statusInfo.level >= 3;
        const isGestionBoletaActive = statusInfo.level >= 4;
        
        const idReferencia = grupo.reservasIndividuales[0].id;
        let actionUrl = `mensajes.html?reservaId=${grupo.reservaIdOriginal}&reservaCompletaId=${idReferencia}`;
        if (grupo.estadoGestion === 'Pendiente Bienvenida') actionUrl += `&accion=marcar_bienvenida_enviada`;
        else if (grupo.estadoGestion === 'Pendiente Cobro') actionUrl += `&accion=marcar_cobro_enviado`;
        const statusHtml = `<a href="${actionUrl}" class="text-sm font-bold text-white px-2 py-1 rounded ${statusInfo.color} hover:opacity-80">${statusInfo.text}</a>`;
        
        card.innerHTML = `
            <div class="flex items-center mb-2">
                ${statusHtml}
                <p class="ml-4 text-lg font-bold text-gray-800">${grupo.clienteNombre}</p>
            </div>
            <div class="text-sm text-gray-600 mt-2 grid grid-cols-2 md:grid-cols-4 gap-2">
                <p><strong>Teléfono:</strong> ${grupo.telefono || 'N/A'}</p>
                <p><strong>Cabañas (${grupo.reservasIndividuales.length}):</strong> ${alojamientos}</p>
                <p><strong>Llegada:</strong> ${formatDate(grupo.fechaLlegada)}</p>
                <p><strong>ID Reserva:</strong> ${grupo.reservaIdOriginal}</p>
            </div>
            <div class="border-t mt-4 pt-3 flex flex-col md:flex-row justify-between items-center text-sm">
                 <div class="grid grid-cols-3 gap-4 font-semibold text-center w-full md:w-2/3">
                    <div><span class="text-gray-500 font-medium">Total:</span> ${formatCurrency(grupo.valorCLP)}</div>
                    <div class="text-green-600"><span class="text-gray-500 font-medium">Abonado:</span> ${formatCurrency(grupo.abono)}</div>
                    <div class="text-red-600"><span class="text-gray-500 font-medium">Saldo:</span> ${formatCurrency(saldo)}</div>
                </div>
                <div class="mt-3 md:mt-0 flex flex-wrap gap-2 justify-center">
                    <button data-gestion="ajuste_tarifa" class="gestion-btn px-3 py-1 bg-yellow-100 text-yellow-800 text-xs font-semibold rounded-md hover:bg-yellow-200">Ajustar Tarifa</button>
                    <button data-gestion="pagos" class="gestion-btn px-3 py-1 text-xs font-semibold rounded-md ${isGestionPagosActive ? 'bg-green-100 text-green-800 hover:bg-green-200' : 'bg-gray-100 text-gray-400 cursor-not-allowed'}" ${!isGestionPagosActive ? 'disabled' : ''}>Gestionar Pagos</button>
                    <button data-gestion="boleta" class="gestion-btn px-3 py-1 text-xs font-semibold rounded-md ${isGestionBoletaActive ? 'bg-purple-100 text-purple-800 hover:bg-purple-200' : 'bg-gray-100 text-gray-400 cursor-not-allowed'}" ${!isGestionBoletaActive ? 'disabled' : ''}>Gestionar Boleta</button>
                </div>
            </div>`;
        card.querySelectorAll('.gestion-btn').forEach(btn => btn.addEventListener('click', (e) => openManagementModal(e.target.dataset.gestion, grupo)));
        return card;
    }

    function openManagementModal(type, grupo) {
        currentGrupo = grupo;
        modalTitle.textContent = `Gestionar ${type.charAt(0).toUpperCase() + type.slice(1).replace('_', ' ')} (Reserva ${grupo.reservaIdOriginal})`;
        
        if (type === 'ajuste_tarifa') {
            renderAjusteTarifaModal();
        } else if (type === 'pagos') {
            renderPagosModal();
        } else if (type === 'boleta') {
            renderBoletaModal();
        }
        
        modal.classList.remove('hidden');
    }
    
    function renderAjusteTarifaModal() {
        if (currentGrupo.reservasIndividuales.length > 1) {
            renderAjusteGrupo();
        } else {
            renderAjusteIndividual();
        }
    }
    
    function renderAjusteIndividual() {
        const reserva = currentGrupo.reservasIndividuales[0];
        modalContent.innerHTML = `...`; // Lógica para ajuste individual
    }

    function renderAjusteGrupo() {
        let cabanasHtml = currentGrupo.reservasIndividuales.map(res => `
            <div class="grid grid-cols-2 gap-4 items-center">
                <label for="valor-${res.id}" class="text-sm font-medium">${res.alojamiento}</label>
                <input type="number" id="valor-${res.id}" data-id="${res.id}" class="valor-input block w-full px-3 py-2 border rounded-md" value="${res.valorCLP}">
            </div>`).join('');
        modalContent.innerHTML = `
            <div class="space-y-4">
                <p class="text-sm text-gray-600">Corrige la distribución del valor total entre las cabañas.</p>
                <div class="space-y-2">${cabanasHtml}</div>
                <div class="border-t pt-3 flex justify-between items-center font-bold"><span>TOTAL:</span><span id="ajuste-valores-total"></span></div>
                <div id="ajuste-valores-status" class="text-sm"></div>
                <div class="text-right"><button id="ajuste-valores-save-btn" class="px-6 py-2 bg-indigo-600 text-white rounded-md">Guardar</button></div>
            </div>`;
        modalContent.querySelectorAll('.valor-input').forEach(input => input.addEventListener('input', updateValoresTotal));
        modalContent.querySelector('#ajuste-valores-save-btn').addEventListener('click', handleSaveAjusteGrupo);
        updateValoresTotal();
    }
    
    function renderPagosModal() {
        modalContent.innerHTML = `
            <div id="lista-pagos" class="space-y-2 max-h-60 overflow-y-auto pr-2">Cargando pagos...</div>
            <div class="border-t pt-4 mt-4">
                <button id="btn-registrar-nuevo-pago" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-md hover:bg-green-700">Registrar Nuevo Pago</button>
            </div>`;
        
        modalContent.querySelector('#btn-registrar-nuevo-pago').addEventListener('click', () => showActionForm('registrar_pago'));
        renderPagosList();
    }
    
    async function renderPagosList() {
        const listaPagosEl = modalContent.querySelector('#lista-pagos');
        const ids = currentGrupo.reservasIndividuales.map(r => r.id);
        const transacciones = await fetchAPI('/api/gestion/transacciones-grupo', { method: 'POST', body: { idsIndividuales: ids } });
        
        if (transacciones.length === 0) {
            listaPagosEl.innerHTML = '<p class="text-sm text-center text-gray-500 p-4">No hay pagos registrados.</p>';
            return;
        }

        const pagosAgrupados = transacciones.reduce((acc, t) => {
            const key = t.fecha.seconds;
            if (!acc[key]) acc[key] = { ...t, montoTotal: 0 };
            acc[key].montoTotal += t.monto;
            return acc;
        }, {});
        
        listaPagosEl.innerHTML = Object.values(pagosAgrupados).map(p => `
            <div class="p-2 border rounded-md">
                <p class="font-semibold">${formatCurrency(p.montoTotal)} - <span class="font-normal text-gray-600">${p.tipo} (${p.medioDePago})</span></p>
                <p class="text-xs text-gray-500">Fecha: ${formatDate(p.fecha)}</p>
            </div>`).join('');
    }

    function renderBoletaModal() {
        showActionForm('marcar_boleta_enviada');
    }
    
    function showActionForm(action) {
        currentAction = action;
        let formTitle = action === 'registrar_pago' ? 'Registrar Nuevo Pago' : 'Subir Boleta/Factura';
        
        modalContent.innerHTML = `
            <form id="modal-form-accion">
                <h4 class="font-semibold text-lg mb-4">${formTitle}</h4>
                <div class="${action === 'registrar_pago' ? '' : 'hidden'} space-y-4">
                    <div><label class="block text-sm">Monto Total (CLP)</label><input type="number" id="monto-input" required class="mt-1 block w-full rounded-md border-gray-300"></div>
                    <div><label class="block text-sm">Medio de Pago</label><select id="medio-pago-select" class="mt-1 block w-full rounded-md border-gray-300"><option>Transferencia</option><option>Efectivo</option><option>Tarjeta</option></select></div>
                    <div class="flex items-center"><input id="pago-final-checkbox" type="checkbox" class="h-4 w-4"><label for="pago-final-checkbox" class="ml-2 text-sm">¿Es el pago final?</label></div>
                </div>
                <div class="mt-4">
                    <label class="block text-sm">Comprobante (Opcional)</label>
                    <input type="file" id="documento-input" class="hidden"/>
                    <div id="paste-zone" class="paste-zone mt-1 rounded-md"><p class="text-gray-500">Selecciona o pega una imagen</p></div>
                    <div class="flex items-center mt-3"><input id="sin-documento-checkbox" type="checkbox" class="h-4 w-4"><label for="sin-documento-checkbox" class="ml-2 text-sm">Registrar sin documento</label></div>
                </div>
                <div id="modal-status" class="mt-2 text-sm text-red-600"></div>
                <div class="mt-5 flex justify-end"><button type="submit" id="modal-save-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md">Guardar</button></div>
            </form>`;

        modalContent.querySelector('#modal-form-accion').addEventListener('submit', handleGroupFormSubmit);
    }

    async function handleGroupFormSubmit(event) {
        event.preventDefault();
        const form = event.target;
        const saveBtn = form.querySelector('#modal-save-btn');
        const statusEl = form.querySelector('#modal-status');
        saveBtn.disabled = true;
        saveBtn.textContent = 'Guardando...';
        statusEl.textContent = '';
        
        const formData = new FormData();
        const detalles = {};
        const idsIndividuales = currentGrupo.reservasIndividuales.map(r => r.id);

        if (currentAction === 'registrar_pago') {
            detalles.monto = form.querySelector('#monto-input').value;
            detalles.medioDePago = form.querySelector('#medio-pago-select').value;
            detalles.esPagoFinal = form.querySelector('#pago-final-checkbox').checked;
            detalles.tipo = detalles.esPagoFinal ? 'Pago Final' : 'Abono';
        }

        detalles.sinDocumento = form.querySelector('#sin-documento-checkbox').checked;
        const docInput = form.querySelector('#documento-input');
        if (docInput && docInput.files.length > 0 && !detalles.sinDocumento) {
            formData.append('documento', docInput.files[0]);
        }

        formData.append('accion', currentAction);
        formData.append('detalles', JSON.stringify(detalles));
        formData.append('idsIndividuales', JSON.stringify(idsIndividuales));
        formData.append('reservaIdOriginal', currentGrupo.reservaIdOriginal);

        try {
            await fetchAPI(`/api/gestion/actualizar-estado`, { method: 'POST', body: formData });
            modal.classList.add('hidden');
            await loadGestion();
        } catch (error) {
            statusEl.textContent = `Error: ${error.message}`;
            saveBtn.disabled = false;
            saveBtn.textContent = 'Guardar';
        }
    }

    function updateFilteredView() {
        const searchTerm = searchInput.value.toLowerCase();
        const filteredGrupos = allGrupos.filter(g => (g.clienteNombre && g.clienteNombre.toLowerCase().includes(searchTerm)) || (g.reservaIdOriginal && g.reservaIdOriginal.toLowerCase().includes(searchTerm)));
        hoyList.innerHTML = ''; proximasList.innerHTML = '';
        if (filteredGrupos.length === 0) {
            noPendientes.classList.remove('hidden');
            [hoyContainer, proximasContainer].forEach(el => el.classList.add('hidden'));
            return;
        }
        noPendientes.classList.add('hidden');
        const today = new Date(new Date().setUTCHours(0,0,0,0));
        const llegadasHoy = [], proximasLlegadas = [];
        filteredGrupos.forEach(grupo => { (new Date(grupo.fechaLlegada).getTime() <= today.getTime() ? llegadasHoy : proximasLlegadas).push(grupo); });
        
        if (llegadasHoy.length > 0) {
            llegadasHoy.forEach(g => hoyList.appendChild(createGrupoCard(g)));
            hoyContainer.classList.remove('hidden');
        } else { hoyContainer.classList.add('hidden'); }
        
        if (proximasLlegadas.length > 0) {
            proximasLlegadas.forEach(g => proximasList.appendChild(createGrupoCard(g)));
            proximasContainer.classList.remove('hidden');
        } else { proximasContainer.classList.add('hidden'); }
    }
    
    async function loadGestion() {
        loadingState.classList.remove('hidden');
        [hoyContainer, proximasContainer, noPendientes].forEach(el => el.classList.add('hidden'));
        try {
            allGrupos = await fetchAPI('/api/gestion/pendientes');
            loadingState.classList.add('hidden');
            updateFilteredView();
        } catch (error) {
            loadingState.innerHTML = `<p class="text-red-500 font-semibold">Error al cargar tareas: ${error.message}</p>`;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const session = checkSession();
        if (session) {
            loader.style.display = 'none';
            appContent.classList.remove('hidden');
            authInfo.innerHTML = `<span class="text-sm text-gray-600 hidden sm:block">${session.userEmail}</span><button id="logout-btn" class="px-3 py-2 bg-red-600 text-white text-xs font-medium rounded-md hover:bg-red-700">Cerrar Sesión</button>`;
            document.getElementById('logout-btn').addEventListener('click', logout);
            
            searchInput.addEventListener('input', updateFilteredView);
            modalCancelBtn.addEventListener('click', () => modal.classList.add('hidden'));
            
            loadGestion();
        }
    });
</script>
</body>
</html>