<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión Diaria - Gestor de Reservas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        #gestion-modal { background-color: rgba(0, 0, 0, 0.5); }
        .paste-zone {
            border: 2px dashed #ccc;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .paste-zone.drag-over {
            background-color: #e0e7ff;
            border-color: #4f46e5;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="loader" class="text-center p-8">
        <p class="text-gray-500">Verificando sesión...</p>
    </div>

    <div id="app-content" class="min-h-screen hidden">
        <nav class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <a href="dashboard.html" class="text-xl font-bold text-gray-800">Gestor de Reservas</a>
                    <div id="auth-info" class="flex items-center space-x-4"></div>
                </div>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <div class="bg-white p-6 md:p-8 rounded-lg shadow">
                <h2 class="text-2xl font-semibold text-gray-900 mb-4">Panel de Gestión Diaria</h2>
                <div id="loading-state" class="text-center py-8">
                    <p class="text-gray-500">Cargando tareas pendientes...</p>
                </div>
                
                <div id="hoy-container" class="hidden">
                    <h3 class="text-xl font-bold text-red-600 mb-4 border-b pb-2">Requiere Acción Hoy</h3>
                    <div id="hoy-list" class="space-y-4"></div>
                </div>

                <div id="proximas-container" class="mt-8 hidden">
                    <h3 class="text-xl font-semibold text-blue-600 mb-4 border-b pb-2">Próximas Llegadas</h3>
                    <div id="proximas-list" class="space-y-4"></div>
                </div>

                 <div id="no-pendientes" class="text-center py-12 hidden">
                    <p class="text-2xl font-semibold text-green-600">¡Todo al día!</p>
                    <p class="text-gray-500 mt-2">No hay reservas con gestiones pendientes.</p>
                </div>
            </div>
        </main>
    </div>

    <div id="gestion-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <h3 class="text-lg font-medium leading-6 text-gray-900" id="modal-title">Registrar Acción</h3>
            <form id="modal-form" class="mt-4 space-y-4">
                
                <div id="pago-fields" class="hidden space-y-4">
                    <div>
                        <label for="monto-input" class="block text-sm font-medium text-gray-700">Monto (CLP)</label>
                        <input type="number" id="monto-input" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="medio-pago-select" class="block text-sm font-medium text-gray-700">Medio de Pago</label>
                        <select id="medio-pago-select" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            <option value="Transferencia">Transferencia</option>
                            <option value="Efectivo">Efectivo</option>
                            <option value="Tarjeta">Tarjeta</option>
                        </select>
                    </div>
                    <div class="flex items-center">
                        <input id="pago-final-checkbox" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
                        <label for="pago-final-checkbox" class="ml-2 block text-sm text-gray-900">¿Es el pago final?</label>
                    </div>
                </div>

                <div id="documento-field" class="hidden">
                    <label for="documento-input" id="documento-label" class="block text-sm font-medium text-gray-700">Comprobante</label>
                    <input type="file" id="documento-input" class="hidden"/>
                    <div id="paste-zone" class="paste-zone mt-1 rounded-md">
                        <p class="text-gray-500">Selecciona un archivo o pega la imagen aquí</p>
                    </div>
                    <div id="preview-container" class="mt-2 hidden">
                        <p class="text-sm font-medium text-gray-700">Archivo seleccionado:</p>
                        <div class="flex items-center">
                            <img id="thumbnail" class="w-12 h-12 object-cover rounded-md" src="">
                            <span id="file-name" class="ml-2 text-sm text-gray-600"></span>
                        </div>
                    </div>
                </div>

                <div id="modal-status" class="mt-2 text-sm text-red-600"></div>
            </form>
            <div class="mt-5 sm:mt-6 sm:grid sm:grid-cols-2 sm:gap-3 sm:grid-flow-row-dense">
                <button type="button" id="modal-save-btn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700">Guardar</button>
                <button type="button" id="modal-cancel-btn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0">Cancelar</button>
            </div>
        </div>
    </div>

<script type="module">
    import { checkSession, logout, fetchAPI } from './api.js';

    // --- Referencias a Elementos ---
    const loader = document.getElementById('loader');
    const appContent = document.getElementById('app-content');
    const authInfo = document.getElementById('auth-info');
    const loadingState = document.getElementById('loading-state');
    const hoyContainer = document.getElementById('hoy-container');
    const hoyList = document.getElementById('hoy-list');
    const proximasContainer = document.getElementById('proximas-container');
    const proximasList = document.getElementById('proximas-list');
    const noPendientes = document.getElementById('no-pendientes');
    
    // --- Referencias a Elementos del Modal ---
    const modal = document.getElementById('gestion-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalForm = document.getElementById('modal-form');
    const pagoFields = document.getElementById('pago-fields');
    const documentoField = document.getElementById('documento-field');
    const documentoLabel = document.getElementById('documento-label');
    const documentoInput = document.getElementById('documento-input');
    const pasteZone = document.getElementById('paste-zone');
    const previewContainer = document.getElementById('preview-container');
    const thumbnail = document.getElementById('thumbnail');
    const fileNameEl = document.getElementById('file-name');
    const modalStatus = document.getElementById('modal-status');
    const modalSaveBtn = document.getElementById('modal-save-btn');
    const modalCancelBtn = document.getElementById('modal-cancel-btn');

    let currentAction = null;
    let currentReservaId = null;

    function getTodayUTC() {
        const today = new Date();
        return new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), today.getUTCDate()));
    }

    function formatDate(dateString) {
        return new Date(dateString).toLocaleDateString('es-CL', { timeZone: 'UTC' });
    }
    
    function getStatusInfo(status) {
        switch (status) {
            case 'Pendiente Bienvenida': return { text: 'PENDIENTE BIENVENIDA', color: 'bg-yellow-500' };
            case 'Pendiente Cobro': return { text: 'PENDIENTE COBRO', color: 'bg-orange-500' };
            case 'Pendiente Pago': return { text: 'PENDIENTE PAGO', color: 'bg-red-600' };
            case 'Pendiente Boleta': return { text: 'PENDIENTE BOLETA', color: 'bg-purple-600' };
            default: return { text: status.toUpperCase(), color: 'bg-gray-400' };
        }
    }
    
    function renderActionButtons(reserva) {
        let buttonsHtml = '';
        const estado = reserva.estadoGestion;

        if (estado === 'Pendiente Pago') {
             buttonsHtml = `<button data-id="${reserva.id}" data-action="registrar_pago" class="action-btn w-full md:w-auto px-4 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700">Registrar Pago/Abono</button>`;
        } else if (estado === 'Pendiente Boleta') {
            buttonsHtml = `<button data-id="${reserva.id}" data-action="marcar_boleta_enviada" class="action-btn w-full md:w-auto px-4 py-2 bg-purple-600 text-white font-semibold rounded-md hover:bg-purple-700">Subir Boleta</button>`;
        } else if (estado === 'Pendiente Cobro') {
             buttonsHtml = `<button data-id="${reserva.id}" data-action="registrar_pago" class="action-btn w-full md:w-auto px-4 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700">Agregar Abono</button>`;
        }
        return `<div class="mt-4 md:mt-0 md:ml-4 flex-shrink-0 flex flex-col md:flex-row">${buttonsHtml}</div>`;
    }

    function createReservaCard(reserva) {
        const card = document.createElement('div');
        card.className = 'p-4 border rounded-lg shadow-sm flex flex-col md:flex-row md:items-center justify-between';
        
        const statusInfo = getStatusInfo(reserva.estadoGestion);
        
        let statusHtml;
        let actionUrl = `mensajes.html?reservaId=${reserva.reservaIdOriginal}&reservaCompletaId=${reserva.id}`;

        if (reserva.estadoGestion === 'Pendiente Bienvenida') {
            actionUrl += `&accion=marcar_bienvenida_enviada`;
            statusHtml = `<a href="${actionUrl}" class="text-sm font-bold text-white px-2 py-1 rounded ${statusInfo.color} hover:opacity-80 transition-opacity">${statusInfo.text}</a>`;
        } else if (reserva.estadoGestion === 'Pendiente Cobro') {
            actionUrl += `&accion=marcar_cobro_enviado`;
            statusHtml = `<a href="${actionUrl}" class="text-sm font-bold text-white px-2 py-1 rounded ${statusInfo.color} hover:opacity-80 transition-opacity">${statusInfo.text}</a>`;
        } else {
            statusHtml = `<span class="text-sm font-bold text-white px-2 py-1 rounded ${statusInfo.color}">${statusInfo.text}</span>`;
        }
        
        card.innerHTML = `
            <div class="flex-grow">
                <div class="flex items-center mb-2 md:mb-0">
                    ${statusHtml}
                    <p class="ml-4 text-lg font-bold text-gray-800">${reserva.clienteNombre}</p>
                </div>
                <div class="text-sm text-gray-600 mt-2 grid grid-cols-2 md:grid-cols-4 gap-2">
                    <p><strong>Teléfono:</strong> ${reserva.telefono || 'N/A'}</p>
                    <p><strong>Cabaña:</strong> ${reserva.alojamiento}</p>
                    <p><strong>Llegada:</strong> ${formatDate(reserva.fechaLlegada)}</p>
                    <p><strong>ID Reserva:</strong> ${reserva.reservaIdOriginal}</p>
                </div>
            </div>
            ${renderActionButtons(reserva)}
        `;

        card.querySelectorAll('.action-btn').forEach(btn => btn.addEventListener('click', handleActionClick));
        return card;
    }

    function showPreview(file) {
        fileNameEl.textContent = file.name;
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                thumbnail.src = e.target.result;
            };
            reader.readAsDataURL(file);
        } else {
            thumbnail.src = ''; // O un ícono genérico de archivo
        }
        previewContainer.classList.remove('hidden');
    }
    
    function setupModalForAction() {
        modalForm.reset();
        pagoFields.classList.add('hidden');
        documentoField.classList.add('hidden');
        previewContainer.classList.add('hidden');
        modalStatus.textContent = '';
        
        switch (currentAction) {
            case 'registrar_pago':
                modalTitle.textContent = 'Registrar Pago o Abono';
                pagoFields.classList.remove('hidden');
                documentoField.classList.remove('hidden');
                documentoLabel.textContent = 'Comprobante de Pago (Opcional)';
                documentoInput.required = false;
                break;
            case 'marcar_boleta_enviada':
                modalTitle.textContent = 'Subir Boleta';
                documentoField.classList.remove('hidden');
                documentoLabel.textContent = 'Archivo de la Boleta';
                documentoInput.required = true;
                break;
        }
        modal.classList.remove('hidden');
    }

    function handleActionClick(event) {
        const button = event.target;
        currentReservaId = button.dataset.id;
        currentAction = button.dataset.action;
        setupModalForAction();
    }

    async function handleModalSave() {
        modalSaveBtn.disabled = true;
        modalSaveBtn.textContent = 'Guardando...';
        modalStatus.textContent = '';

        const formData = new FormData();
        const detalles = {};

        if (currentAction === 'registrar_pago') {
            const monto = document.getElementById('monto-input').value;
            if (!monto || monto <= 0) {
                modalStatus.textContent = 'El monto debe ser un número positivo.';
                modalSaveBtn.disabled = false;
                modalSaveBtn.textContent = 'Guardar';
                return;
            }
            detalles.monto = monto;
            detalles.medioDePago = document.getElementById('medio-pago-select').value;
            detalles.esPagoFinal = document.getElementById('pago-final-checkbox').checked;
            detalles.tipo = detalles.esPagoFinal ? 'Pago Final' : 'Abono';
        }

        if (documentoInput.files.length > 0) {
            formData.append('documento', documentoInput.files[0]);
        } else if (currentAction === 'marcar_boleta_enviada') {
            modalStatus.textContent = 'Debes seleccionar un archivo para la boleta.';
            modalSaveBtn.disabled = false;
            modalSaveBtn.textContent = 'Guardar';
            return;
        }

        formData.append('accion', currentAction);
        formData.append('detalles', JSON.stringify(detalles));

        try {
            await fetchAPI(`/api/gestion/actualizar-estado/${currentReservaId}`, {
                method: 'POST',
                body: formData
            });
            modal.classList.add('hidden');
            loadGestion();
        } catch (error) {
            console.error('Error al guardar desde el modal:', error);
            modalStatus.textContent = `Error: ${error.message}`;
        } finally {
            modalSaveBtn.disabled = false;
            modalSaveBtn.textContent = 'Guardar';
        }
    }

    async function loadGestion() {
        loadingState.classList.remove('hidden');
        hoyContainer.classList.add('hidden');
        proximasContainer.classList.add('hidden');
        noPendientes.classList.add('hidden');
        hoyList.innerHTML = '';
        proximasList.innerHTML = '';
        
        try {
            const reservas = await fetchAPI('/api/gestion/pendientes');
            loadingState.classList.add('hidden');

            if (reservas.length === 0) {
                noPendientes.classList.remove('hidden');
                return;
            }

            const today = getTodayUTC();
            const llegadasHoy = [];
            const proximasLlegadas = [];

            reservas.forEach(reserva => {
                if (new Date(reserva.fechaLlegada).getTime() <= today.getTime()) {
                    llegadasHoy.push(reserva);
                } else {
                    proximasLlegadas.push(reserva);
                }
            });

            if (llegadasHoy.length > 0) {
                llegadasHoy.forEach(res => hoyList.appendChild(createReservaCard(res)));
                hoyContainer.classList.remove('hidden');
            }

            if (proximasLlegadas.length > 0) {
                proximasLlegadas.forEach(res => proximasList.appendChild(createReservaCard(res)));
                proximasContainer.classList.remove('hidden');
            }

        } catch (error) {
            console.error('Error al cargar la gestión:', error);
            loadingState.innerHTML = `<p class="text-red-500 font-semibold">Error al cargar las tareas: ${error.message}</p>`;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const session = checkSession();
        if (session) {
            loader.style.display = 'none';
            appContent.classList.remove('hidden');
            authInfo.innerHTML = `
                <span class="text-sm text-gray-600 hidden sm:block">${session.userEmail}</span>
                <button id="logout-btn" class="px-3 py-2 bg-red-600 text-white text-xs font-medium rounded-md hover:bg-red-700">Cerrar Sesión</button>
            `;
            document.getElementById('logout-btn').addEventListener('click', logout);
            
            modalCancelBtn.addEventListener('click', () => modal.classList.add('hidden'));
            modalSaveBtn.addEventListener('click', handleModalSave);

            // --- Lógica para Pegar y Seleccionar Archivo ---
            pasteZone.addEventListener('click', () => documentoInput.click());
            documentoInput.addEventListener('change', () => {
                if (documentoInput.files.length > 0) {
                    showPreview(documentoInput.files[0]);
                }
            });

            pasteZone.addEventListener('paste', (e) => {
                e.preventDefault();
                const items = e.clipboardData.items;
                for (const item of items) {
                    if (item.type.indexOf('image') !== -1) {
                        const blob = item.getAsFile();
                        const file = new File([blob], "captura-pegada.png", { type: blob.type });
                        
                        // Usamos un DataTransfer para asignar el archivo al input
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(file);
                        documentoInput.files = dataTransfer.files;
                        
                        showPreview(file);
                        break;
                    }
                }
            });

            // --- Lógica para Drag & Drop (opcional pero mejora la experiencia) ---
            pasteZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                pasteZone.classList.add('drag-over');
            });
            pasteZone.addEventListener('dragleave', () => {
                pasteZone.classList.remove('drag-over');
            });
            pasteZone.addEventListener('drop', (e) => {
                e.preventDefault();
                pasteZone.classList.remove('drag-over');
                if (e.dataTransfer.files.length > 0) {
                    documentoInput.files = e.dataTransfer.files;
                    showPreview(documentoInput.files[0]);
                }
            });

            loadGestion();
        }
    });
</script>
</body>
</html>