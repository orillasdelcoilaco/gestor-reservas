<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generar Presupuesto - Gestor de Reservas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style> 
        body { font-family: 'Inter', sans-serif; }
        #client-results-list > div:hover { background-color: #f0f4ff; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="loader" class="text-center p-8">
        <p class="text-gray-500">Verificando sesi√≥n...</p>
    </div>

    <div id="app-content" class="min-h-screen hidden">
        <nav class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <a href="dashboard.html" class="text-xl font-bold text-gray-800">Gestor de Reservas</a>
                    <div id="auth-info" class="flex items-center space-x-4"></div>
                </div>
            </div>
        </nav>
        <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <div class="bg-white p-8 rounded-lg shadow space-y-8">
                <div>
                    <h2 class="text-2xl font-semibold text-gray-900 mb-4">Generador de Presupuestos</h2>
                    
                    <div class="p-4 border rounded-md bg-gray-50 mb-6">
                        <h3 class="font-semibold text-gray-800 mb-2">1. Datos del Cliente</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="client-search" class="block text-sm font-medium text-gray-700">Buscar cliente existente</label>
                                <input type="text" id="client-search" placeholder="Escribe para buscar..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                <div id="client-results-list" class="mt-1 border rounded-md max-h-32 overflow-y-auto bg-white"></div>
                            </div>
                            <div id="new-client-fields" class="space-y-2">
                                <p class="text-sm font-medium text-gray-700">... o a√±ade un cliente nuevo</p>
                                <input type="text" id="new-client-name" placeholder="Nombre completo" class="block w-full rounded-md border-gray-300 shadow-sm">
                                <input type="text" id="new-client-company" placeholder="Empresa (Opcional)" class="block w-full rounded-md border-gray-300 shadow-sm">
                                <input type="tel" id="new-client-phone" placeholder="Tel√©fono (Opcional)" class="block w-full rounded-md border-gray-300 shadow-sm">
                                <input type="email" id="new-client-email" placeholder="Email (Opcional)" class="block w-full rounded-md border-gray-300 shadow-sm">
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-col md:flex-row items-end space-y-4 md:space-y-0 md:space-x-4 pb-6 border-b">
                        <div>
                            <h3 class="font-semibold text-gray-800 mb-2">2. Fechas y Personas</h3>
                            <label for="fecha-llegada" class="block text-sm font-medium text-gray-700">Fecha de Llegada</label>
                            <input type="date" id="fecha-llegada" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                        <div>
                            <label for="fecha-salida" class="block text-sm font-medium text-gray-700">Fecha de Salida</label>
                            <input type="date" id="fecha-salida" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                        <div>
                            <label for="personas" class="block text-sm font-medium text-gray-700">N¬∞ de Personas</label>
                            <input type="number" id="personas" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                        <button id="generar-btn" class="w-full md:w-auto bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700">
                            Generar Propuesta
                        </button>
                    </div>
                </div>

                <div id="status-container" class="text-center text-gray-500 hidden p-4"></div>

                <div id="results-container" class="hidden grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">3. Propuesta y Modificaci√≥n de Caba√±as</h3>
                            <div id="suggestion-list" class="mt-2 space-y-2"></div>
                        </div>
                        <div>
                            <h4 class="text-md font-medium text-gray-700">Otras Caba√±as Disponibles</h4>
                            <div id="available-list" class="mt-2 space-y-2"></div>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-gray-800">4. Presupuesto Final</h3>
                        <textarea id="presupuesto-texto" rows="25" class="w-full p-2 border border-gray-300 rounded-md shadow-sm bg-gray-50 font-mono text-xs"></textarea>
                        <div class="flex space-x-2">
                           <button id="copy-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md text-sm font-medium hover:bg-gray-300">Copiar Texto</button>
                           <button id="save-btn" class="bg-green-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-green-700">Guardar Presupuesto</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

<script type="module">
    import { checkSession, logout, fetchAPI } from './api.js';

    // --- Referencias a Elementos ---
    const generarBtn = document.getElementById('generar-btn');
    const statusContainer = document.getElementById('status-container');
    const resultsContainer = document.getElementById('results-container');
    const suggestionList = document.getElementById('suggestion-list');
    const availableList = document.getElementById('available-list');
    const presupuestoTexto = document.getElementById('presupuesto-texto');
    const copyBtn = document.getElementById('copy-btn');
    const saveBtn = document.getElementById('save-btn');
    const clientSearchInput = document.getElementById('client-search');
    const clientResultsList = document.getElementById('client-results-list');
    const newClientNameInput = document.getElementById('new-client-name');
    const newClientCompanyInput = document.getElementById('new-client-company');
    const newClientPhoneInput = document.getElementById('new-client-phone');
    const newClientEmailInput = document.getElementById('new-client-email');
    
    let allClients = [];
    let selectedClient = null;
    let fullData = {};
    let selectedCabanas = [];
    let currentPricing = {};

    function formatCurrency(value) {
        return `$${(value || 0).toLocaleString('es-CL')}`;
    }

    function createCabanaCheckbox(cabana, isSuggested) {
        const div = document.createElement('div');
        div.className = 'p-2 border rounded-md flex items-center justify-between';
        div.innerHTML = `
            <div>
                <input type="checkbox" id="cb-${cabana.id}" data-id="${cabana.id}" class="cabana-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded" ${isSuggested ? 'checked' : ''}>
                <label for="cb-${cabana.id}" class="ml-2 font-medium">${cabana.nombre}</label>
                <span class="ml-2 text-sm text-gray-500">(Cap: ${cabana.capacidad})</span>
            </div>
        `;
        return div;
    }

    function renderSelectionUI() {
        suggestionList.innerHTML = '';
        availableList.innerHTML = '';

        if (!fullData.suggestion) return;

        const suggestedIds = new Set(fullData.suggestion.cabanas.map(c => c.id));
        selectedCabanas = [...fullData.suggestion.cabanas];

        fullData.suggestion.cabanas.forEach(c => {
            suggestionList.appendChild(createCabanaCheckbox(c, true));
        });

        fullData.availableCabanas.forEach(c => {
            if (!suggestedIds.has(c.id)) {
                availableList.appendChild(createCabanaCheckbox(c, false));
            }
        });
        
        document.querySelectorAll('.cabana-checkbox').forEach(cb => {
            cb.addEventListener('change', handleSelectionChange);
        });

        generatePresupuestoText(fullData.suggestion.pricing);
    }

    async function handleSelectionChange() {
        const selectedIds = new Set();
        document.querySelectorAll('.cabana-checkbox:checked').forEach(cb => {
            selectedIds.add(cb.dataset.id);
        });
        selectedCabanas = fullData.allCabanas.filter(c => selectedIds.has(c.id));

        if (selectedCabanas.length === 0) {
            generatePresupuestoText({ totalPrice: 0, nights: 0, details: [] });
            return;
        }

        try {
            const payload = {
                fechaLlegada: document.getElementById('fecha-llegada').value,
                fechaSalida: document.getElementById('fecha-salida').value,
                cabanas: selectedCabanas
            };
            const newPricing = await fetchAPI('/api/presupuestos/recalcular', { method: 'POST', body: payload });
            generatePresupuestoText(newPricing);
        } catch (error) {
            presupuestoTexto.value = `Error al recalcular el precio: ${error.message}`;
        }
    }
    
    function generatePresupuestoText(pricing) {
        currentPricing = pricing; // Guardamos los precios actuales
        const fechaLlegada = new Date(document.getElementById('fecha-llegada').value + 'T00:00:00Z');
        const fechaSalida = new Date(document.getElementById('fecha-salida').value + 'T00:00:00Z');
        const hoy = new Date();
        
        let clientName = selectedClient ? selectedClient.nombre : newClientNameInput.value.trim();
        let clientCompany = selectedClient ? '' : newClientCompanyInput.value.trim();
        const dirigidoA = clientCompany ? `${clientName} ‚Äì ${clientCompany}` : clientName;

        let texto = `üèûÔ∏è Orillas del Coilaco - Turismo & Naturaleza\n`;
        texto += `www.orillasdelcoilaco.cl ‚Äì reservas@orillasdelcoilaco.cl ‚Äì üìû +56 9 7518 0855\n`;
        texto += `--------------------------------------------------------------------------\n`;
        texto += `üìå Presupuesto de Alojamiento\n`;
        texto += `Dirigido a: ${dirigidoA}\n`;
        texto += `Fecha: ${hoy.toLocaleDateString('es-CL')}\n`;
        texto += `Solicitado para: ${document.getElementById('personas').value} personas\n`;
        texto += `Estad√≠a: ${fechaLlegada.toLocaleDateString('es-CL', {timeZone:'UTC'})} al ${fechaSalida.toLocaleDateString('es-CL', {timeZone:'UTC'})} (${pricing.nights} noches)\n\n`;

        texto += `üè° Detalle de las Caba√±as Asignadas\n`;
        
        if (pricing.details && pricing.details.length > 0) {
            pricing.details.forEach(detail => {
                const cabanaInfo = fullData.allCabanas.find(c => c.nombre === detail.nombre);
                texto += `\nüîπ ${cabanaInfo.nombre} (Capacidad: ${cabanaInfo.capacidad} personas)\n`;
                if (cabanaInfo.descripcion) texto += `${cabanaInfo.descripcion}\n`;
                if (cabanaInfo.camas) texto += `Camas: ${cabanaInfo.camas}\n`;
                if (cabanaInfo.equipamiento && cabanaInfo.equipamiento.length > 0) {
                     texto += `Equipamiento: ${cabanaInfo.equipamiento.join(', ')}\n`;
                }
                if(cabanaInfo.linkFotos) texto += `üì∑ Ver fotos: ${cabanaInfo.linkFotos}\n`;
                texto += `Valor por noche: ${formatCurrency(detail.precioPorNoche)}\n`;
                texto += `Total por ${pricing.nights} noches: ${formatCurrency(detail.precioTotal)}\n`;
            });
        } else {
            texto += `\nNinguna caba√±a seleccionada.\n`;
        }

        texto += `\nüìä Resumen del Presupuesto\n`;
        texto += `Cantidad de caba√±as: ${selectedCabanas.length}\n`;
        texto += `Capacidad total: ${selectedCabanas.reduce((acc, c) => acc + c.capacidad, 0)} personas\n`;
        texto += `Duraci√≥n estad√≠a: ${pricing.nights} noches\n`;
        texto += `Valor total: ${formatCurrency(pricing.totalPrice)}\n\n`;

        texto += `Incluye:\n‚úÖ Estacionamiento privado\n‚úÖ Ropa de cama y toallas\n‚úÖ Acceso a orillas del r√≠o Coilaco\n‚úÖ Terraza techada en cada caba√±a\n\n`;
        
        texto += `üíµ Condiciones de Reserva\n`;
        texto += `Para confirmar se solicita un 50% de abono.\n`;
        texto += `El saldo (50%) debe estar cancelado 48 horas antes del check-in.\n`;
        texto += `Check-in: 15:00 hrs ‚Äì Check-out: 11:00 hrs.\n\n`;
        
        texto += `üìç Ubicaci√≥n: http://googleusercontent.com/maps/google.com/3`;

        texto += `\n\n‚úçÔ∏è Atentamente,\nPablo Meza\nOrillas del Coilaco\n`;
        texto += `üìß reservas@orillasdelcoilaco.cl\nüì± +56 9 7518 0855\nüåê www.orillasdelcoilaco.cl`;

        presupuestoTexto.value = texto;
    }

    async function loadClients() {
        try {
            allClients = await fetchAPI('/api/clientes/simplificado');
        } catch (error) {
            console.error("No se pudieron cargar los clientes:", error);
        }
    }

    function filterClients() {
        const searchTerm = clientSearchInput.value.toLowerCase();
        clientResultsList.innerHTML = '';
        if (!searchTerm) return;

        const filtered = allClients.filter(c => c.nombre.toLowerCase().includes(searchTerm) || c.telefono.includes(searchTerm));
        
        filtered.slice(0, 5).forEach(client => {
            const div = document.createElement('div');
            div.className = 'p-2 cursor-pointer';
            div.textContent = `${client.nombre} (${client.telefono})`;
            div.onclick = () => selectClient(client);
            clientResultsList.appendChild(div);
        });
    }
    
    function selectClient(client) {
        selectedClient = client;
        clientSearchInput.value = client.nombre;
        clientResultsList.innerHTML = '';
        newClientNameInput.value = '';
        newClientCompanyInput.value = '';
        newClientPhoneInput.value = '';
        newClientEmailInput.value = '';
        newClientNameInput.disabled = true;
        newClientCompanyInput.disabled = true;
        newClientPhoneInput.disabled = true;
        newClientEmailInput.disabled = true;
    }
    
    function clearClientSelection() {
        selectedClient = null;
        clientSearchInput.value = '';
        newClientNameInput.disabled = false;
        newClientCompanyInput.disabled = false;
        newClientPhoneInput.disabled = false;
        newClientEmailInput.disabled = false;
    }

    document.addEventListener('DOMContentLoaded', () => {
        const session = checkSession();
        if (session) {
            loader.style.display = 'none';
            appContent.classList.remove('hidden');
            authInfo.innerHTML = `
                <span class="text-sm text-gray-600 hidden sm:block">${session.userEmail}</span>
                <button id="logout-btn" class="px-3 py-2 bg-red-600 text-white text-xs font-medium rounded-md hover:bg-red-700">Cerrar Sesi√≥n</button>
            `;
            document.getElementById('logout-btn').addEventListener('click', logout);
            
            loadClients();
            clientSearchInput.addEventListener('input', filterClients);
            newClientNameInput.addEventListener('input', clearClientSelection);

            generarBtn.addEventListener('click', async () => {
                const payload = {
                    fechaLlegada: document.getElementById('fecha-llegada').value,
                    fechaSalida: document.getElementById('fecha-salida').value,
                    personas: document.getElementById('personas').value,
                };

                if (!payload.fechaLlegada || !payload.fechaSalida || !payload.personas || (!selectedClient && !newClientNameInput.value)) {
                    alert('Por favor, completa los datos del cliente, fechas y cantidad de personas.');
                    return;
                }

                generarBtn.disabled = true;
                generarBtn.textContent = 'Generando...';
                statusContainer.textContent = 'Buscando disponibilidad y calculando...';
                statusContainer.classList.remove('hidden');
                resultsContainer.classList.add('hidden');

                try {
                    fullData = await fetchAPI('/api/presupuestos/generar', { method: 'POST', body: payload });
                    
                    if (fullData.suggestion) {
                        statusContainer.classList.add('hidden');
                        resultsContainer.classList.remove('hidden');
                        renderSelectionUI();
                    } else {
                        statusContainer.textContent = fullData.message || 'No se pudo generar una propuesta.';
                    }

                } catch (error) {
                    statusContainer.textContent = `Error: ${error.message}`;
                } finally {
                    generarBtn.disabled = false;
                    generarBtn.textContent = 'Generar Propuesta';
                }
            });

            copyBtn.addEventListener('click', () => {
                navigator.clipboard.writeText(presupuestoTexto.value).then(() => {
                    const originalText = copyBtn.textContent;
                    copyBtn.textContent = '¬°Copiado!';
                    setTimeout(() => { copyBtn.textContent = originalText; }, 2000);
                });
            });
            
            saveBtn.addEventListener('click', async () => {
                let clienteParaGuardar;

                if (selectedClient) {
                    clienteParaGuardar = { id: selectedClient.id, nombre: selectedClient.nombre };
                } else if (newClientNameInput.value.trim()) {
                    clienteParaGuardar = {
                        nombre: newClientNameInput.value.trim(),
                        empresa: newClientCompanyInput.value.trim(),
                        telefono: newClientPhoneInput.value.trim(),
                        email: newClientEmailInput.value.trim(),
                    };
                } else {
                    alert('Debes seleccionar o ingresar un cliente para guardar el presupuesto.');
                    return;
                }

                const presupuestoParaGuardar = {
                    fechaLlegada: document.getElementById('fecha-llegada').value,
                    fechaSalida: document.getElementById('fecha-salida').value,
                    personas: parseInt(document.getElementById('personas').value),
                    cabanasSeleccionadas: selectedCabanas,
                    valorTotal: currentPricing.totalPrice
                };

                saveBtn.disabled = true;
                saveBtn.textContent = 'Guardando...';

                try {
                    const result = await fetchAPI('/api/presupuestos/guardar', {
                        method: 'POST',
                        body: { cliente: clienteParaGuardar, presupuesto: presupuestoParaGuardar }
                    });
                    alert(`Presupuesto guardado con √©xito. ID: ${result.id}`);
                    // Opcional: limpiar formulario o redirigir
                } catch (error) {
                    alert(`Error al guardar el presupuesto: ${error.message}`);
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Guardar Presupuesto';
                }
            });
        }
    });
</script>
</body>
</html>