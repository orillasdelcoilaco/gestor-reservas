<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes R√°pidos - Gestor de Reservas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .report-box { white-space: pre-wrap; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="loader" class="text-center p-8">
        <p class="text-gray-500">Verificando sesi√≥n...</p>
    </div>

    <div id="app-content" class="min-h-screen hidden">
        <nav class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <a href="dashboard.html" class="text-xl font-bold text-gray-800">Gestor de Reservas</a>
                    <div id="auth-info" class="flex items-center space-x-4"></div>
                </div>
            </div>
        </nav>
        <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 md:p-8 rounded-lg shadow">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">Reporte de Actividad Diaria</h2>
                    <div class="flex items-end space-x-4">
                        <div class="flex-grow">
                            <label for="fecha-diaria" class="block text-sm font-medium text-gray-700">Selecciona una fecha</label>
                            <input type="date" id="fecha-diaria" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                        <button id="btn-generar-diario" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700">Generar</button>
                    </div>
                    <div id="reporte-diario-container" class="mt-6 hidden">
                        <div id="reporte-diario-box" class="report-box p-4 bg-gray-50 border rounded-md text-sm"></div>
                        <button id="btn-copiar-diario" class="mt-3 bg-gray-200 text-gray-800 px-4 py-2 rounded-md text-sm font-medium hover:bg-gray-300">Copiar Reporte</button>
                    </div>
                </div>

                <div class="bg-white p-6 md:p-8 rounded-lg shadow">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">Reporte de Disponibilidad</h2>
                    <div class="flex items-end space-x-4">
                        <div class="flex-grow">
                            <label for="fecha-disponibilidad-inicio" class="block text-sm font-medium text-gray-700">Desde</label>
                            <input type="date" id="fecha-disponibilidad-inicio" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                         <div class="flex-grow">
                            <label for="fecha-disponibilidad-fin" class="block text-sm font-medium text-gray-700">Hasta</label>
                            <input type="date" id="fecha-disponibilidad-fin" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                        <button id="btn-generar-disponibilidad" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700">Generar</button>
                    </div>
                     <div id="reporte-disponibilidad-container" class="mt-6 hidden">
                        <div id="reporte-disponibilidad-box" class="report-box p-4 bg-gray-50 border rounded-md text-sm"></div>
                        <button id="btn-copiar-disponibilidad" class="mt-3 bg-gray-200 text-gray-800 px-4 py-2 rounded-md text-sm font-medium hover:bg-gray-300">Copiar Reporte</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

<script type="module">
    import { checkSession, logout, fetchAPI } from './api.js';

    document.addEventListener('DOMContentLoaded', () => {
        const session = checkSession();
        if (!session) return;
        
        document.getElementById('loader').style.display = 'none';
        document.getElementById('app-content').classList.remove('hidden');
        document.getElementById('auth-info').innerHTML = `
            <span class="text-sm text-gray-600 hidden sm:block">${session.userEmail}</span>
            <button id="logout-btn" class="px-3 py-2 bg-red-600 text-white text-xs font-medium rounded-md hover:bg-red-700">Cerrar Sesi√≥n</button>
        `;
        document.getElementById('logout-btn').addEventListener('click', logout);

        const formatDate = (dateStr) => dateStr.split('-').reverse().join('-');
        
        // --- L√≥gica para Reporte Diario ---
        const btnGenerarDiario = document.getElementById('btn-generar-diario');
        const containerDiario = document.getElementById('reporte-diario-container');
        const boxDiario = document.getElementById('reporte-diario-box');

        btnGenerarDiario.addEventListener('click', async () => {
            const fecha = document.getElementById('fecha-diaria').value;
            if (!fecha) { alert('Por favor, selecciona una fecha.'); return; }
            
            boxDiario.textContent = 'Generando...';
            containerDiario.classList.remove('hidden');

            try {
                const data = await fetchAPI(`/api/reportes/actividad-diaria?fecha=${fecha}`);
                let reporteTexto = `üü¢ Reservas activas hoy (${formatDate(fecha)})\n\n`;
                data.forEach(item => {
                    reporteTexto += `üè° Caba√±a ${item.cabana}\n`;
                    if (item.estado === 'Llega hoy') {
                        reporteTexto += `üßë‚Äçü§ù‚Äçüßë Llega hoy:\n${item.cliente}\nReserva: ${item.reservaId}\nFechas: ${item.fechas.replace(/\//g, '-')}\nCanal: ${item.canal}\n\n`;
                    } else if (item.estado === 'En estad√≠a') {
                        reporteTexto += `üí§ En estad√≠a:\n${item.cliente}\nReserva: ${item.reservaId}\n\n`;
                    } else {
                        reporteTexto += `‚ùå sin reserva hoy\n\n`;
                    }
                });
                boxDiario.textContent = reporteTexto;
            } catch (error) {
                boxDiario.textContent = `Error al generar el reporte: ${error.message}`;
            }
        });

        document.getElementById('btn-copiar-diario').addEventListener('click', () => {
            navigator.clipboard.writeText(boxDiario.textContent);
        });

        // --- L√≥gica para Reporte de Disponibilidad ---
        const btnGenerarDisponibilidad = document.getElementById('btn-generar-disponibilidad');
        const containerDisponibilidad = document.getElementById('reporte-disponibilidad-container');
        const boxDisponibilidad = document.getElementById('reporte-disponibilidad-box');

        btnGenerarDisponibilidad.addEventListener('click', async () => {
            const fechaInicio = document.getElementById('fecha-disponibilidad-inicio').value;
            const fechaFin = document.getElementById('fecha-disponibilidad-fin').value;
            if (!fechaInicio || !fechaFin) { alert('Por favor, selecciona ambas fechas.'); return; }

            boxDisponibilidad.textContent = 'Generando...';
            containerDisponibilidad.classList.remove('hidden');

            try {
                const data = await fetchAPI(`/api/reportes/disponibilidad-periodo?fechaInicio=${fechaInicio}&fechaFin=${fechaFin}`);
                let reporteTexto = `üëã Hola, esta es nuestra disponibilidad desde ${formatDate(fechaInicio)} hasta ${formatDate(fechaFin)}:\n\n`;
                
                data.forEach(item => {
                    if (item.periodos.length > 0) {
                        reporteTexto += `üè° Caba√±a ${item.cabana}:\n${item.link}\nValor: $${item.valor.toLocaleString('es-CL')}\nCapacidad: ${item.capacidad} personas\n`;
                        item.periodos.forEach(p => {
                            if (p.fin) {
                                // Restar un d√≠a a la fecha de fin para que sea inclusiva
                                const finDate = new Date(p.fin + 'T00:00:00Z');
                                finDate.setUTCDate(finDate.getUTCDate() - 1);
                                reporteTexto += `üëç Del ${formatDate(p.inicio)} al ${formatDate(finDate.toISOString().split('T')[0])}\n`;
                            } else {
                                reporteTexto += `üëç Del ${formatDate(p.inicio)} en adelante\n`;
                            }
                        });
                        reporteTexto += `\n`;
                    }
                });
                boxDisponibilidad.textContent = reporteTexto;
            } catch (error) {
                boxDisponibilidad.textContent = `Error al generar el reporte: ${error.message}`;
            }
        });

        document.getElementById('btn-copiar-disponibilidad').addEventListener('click', () => {
            navigator.clipboard.writeText(boxDisponibilidad.textContent);
        });
    });
</script>
</body>
</html>