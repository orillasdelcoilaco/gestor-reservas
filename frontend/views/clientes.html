<div class="bg-white p-6 md:p-8 rounded-lg shadow">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
        <h2 class="text-2xl font-semibold text-gray-900">Listado de Clientes</h2>
        <input type="text" id="search-input" placeholder="Buscar por nombre, teléfono, email..." class="mt-4 md:mt-0 w-full md:w-1/3 px-3 py-2 border border-gray-300 rounded-md shadow-sm">
    </div>
    
    <div class="table-container overflow-y-auto border rounded-lg">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nombre</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Teléfono</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total Reservas</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Primer Canal</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                </tr>
            </thead>
            <tbody id="clientes-table-body" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
    </div>
    <div id="loading-state" class="text-center p-8">
        <p class="text-gray-500">Cargando clientes...</p>
    </div>
</div>

<div id="edit-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center">
            <h3 class="text-lg font-medium leading-6 text-gray-900" id="modal-title">Editar Cliente</h3>
            <button type="button" id="delete-btn" class="px-3 py-1 bg-red-600 text-white text-xs font-medium rounded-md hover:bg-red-700">Eliminar Cliente</button>
            </div>
        <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-8">
            <form id="edit-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" id="firstname-input" placeholder="Nombre" class="block w-full px-3 py-2 border rounded-md">
                    <input type="text" id="lastname-input" placeholder="Apellido" class="block w-full px-3 py-2 border rounded-md">
                </div>
                <input type="tel" id="phone-input" placeholder="Teléfono" class="block w-full px-3 py-2 border rounded-md">
                <input type="email" id="email-input" placeholder="Email" class="block w-full px-3 py-2 border rounded-md">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="fuente-select" class="block text-sm font-medium">Fuente</label>
                        <select id="fuente-select" class="block w-full px-3 py-2 border rounded-md mt-1"></select>
                    </div>
                     <div>
                        <label class="block text-sm font-medium">Ubicación Geográfica</label>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-1">
                            <input type="text" id="pais-input" placeholder="País" class="block w-full px-3 py-2 border rounded-md">
                            <input type="text" id="region-input" placeholder="Región" class="block w-full px-3 py-2 border rounded-md">
                            <input type="text" id="ciudad-input" placeholder="Ciudad" class="block w-full px-3 py-2 border rounded-md">
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium">Calificación</label>
                    <div id="calificacion-stars" class="flex items-center" data-rating="0">
                        <span class="star" data-value="1">★</span>
                        <span class="star" data-value="2">★</span>
                        <span class="star" data-value="3">★</span>
                        <span class="star" data-value="4">★</span>
                        <span class="star" data-value="5">★</span>
                    </div>
                </div>
                <textarea id="notas-input" rows="3" placeholder="Notas adicionales..." class="block w-full px-3 py-2 border rounded-md"></textarea>
                <div id="modal-status" class="mt-2 text-sm"></div>
            </form>

            <div>
                <h4 class="text-md font-semibold text-gray-800 border-b pb-2 mb-2">Historial de Reservas</h4>
                <div id="historial-reservas-container" class="max-h-64 overflow-y-auto">
                    <p class="text-gray-500">Cargando historial...</p>
                </div>
            </div>
        </div>
        <div class="mt-5 sm:mt-6 sm:grid sm:grid-cols-2 sm:gap-3 sm:grid-flow-row-dense">
            <button type="button" id="save-btn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700">Guardar Cambios</button>
            <button type="button" id="cancel-btn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0">Cancelar</button>
        </div>
    </div>
</div>

<script type="module">
    import { fetchAPI } from '../api.js';

    const clientesTableBody = document.getElementById('clientes-table-body');
    const loadingState = document.getElementById('loading-state');
    const searchInput = document.getElementById('search-input');
    const modal = document.getElementById('edit-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalStatus = document.getElementById('modal-status');
    const saveBtn = document.getElementById('save-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    const deleteBtn = document.getElementById('delete-btn');
    
    let allClients = [];
    let editingClientId = null;

    const fuentes = ['instagram', 'facebook', 'tiktok', 'google', 'ia', 'boca a boca'];

    function populateDropdowns() {
        const fuenteSelect = document.getElementById('fuente-select');
        fuentes.forEach(f => fuenteSelect.add(new Option(f.charAt(0).toUpperCase() + f.slice(1), f)));
    }

    function setupStars() {
        const starsContainer = document.getElementById('calificacion-stars');
        starsContainer.addEventListener('click', e => {
            if (e.target.classList.contains('star')) {
                const rating = e.target.dataset.value;
                starsContainer.dataset.rating = rating;
                updateStarDisplay(rating);
            }
        });
    }

    function updateStarDisplay(rating) {
        const stars = document.querySelectorAll('#calificacion-stars .star');
        stars.forEach(star => {
            star.classList.toggle('selected', star.dataset.value <= rating);
        });
    }

    function renderTable(clients) {
        clientesTableBody.innerHTML = '';
        if (clients.length === 0) {
            loadingState.innerHTML = '<p class="text-gray-500">No se encontraron clientes.</p>';
            loadingState.style.display = 'block';
            return;
        }
        loadingState.style.display = 'none';

        clients.forEach(cliente => {
            const row = document.createElement('tr');
            row.className = "hover:bg-gray-50";

            let syncHtml = cliente.googleContactSynced
                ? '<span class="text-xs text-green-600" title="Sincronizado con Google Contacts">✅ Sincronizado</span>'
                : `<button class="sync-btn text-blue-600 hover:text-blue-900 text-xs" data-id="${cliente.id}">Sincronizar</button>`;

            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-800">${cliente.nombre}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${cliente.telefono}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${cliente.email}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-center text-gray-800">${cliente.totalReservas}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${cliente.canal}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-4">
                    <button class="edit-btn text-indigo-600 hover:text-indigo-900 text-xs" data-id="${cliente.id}">Editar</button>
                    ${syncHtml}
                </td>`;
            clientesTableBody.appendChild(row);
        });

        document.querySelectorAll('.edit-btn').forEach(b => b.addEventListener('click', handleEditClick));
        document.querySelectorAll('.sync-btn').forEach(b => b.addEventListener('click', handleSyncClick));
    }

    async function handleSyncClick(event) {
        const button = event.target;
        const clienteId = button.dataset.id;
        const cliente = allClients.find(c => c.id === clienteId);
        if (!cliente || !confirm(`¿Sincronizar a "${cliente.nombre}" con Google Contacts?`)) return;

        button.disabled = true;
        button.textContent = 'Sincronizando...';
        try {
            const result = await fetchAPI(`/api/clientes/${clienteId}/sincronizar-google`, { method: 'POST' });
            alert(result.message);
            await loadClients();
        } catch (error) {
            alert(`Error al sincronizar: ${error.message}`);
            button.disabled = false;
            button.textContent = 'Sincronizar';
        }
    }

    async function handleEditClick(event) {
        editingClientId = event.target.dataset.id;
        const cliente = allClients.find(c => c.id === editingClientId);
        if (!cliente) return;

        modalTitle.textContent = `Editar Cliente: ${cliente.nombre}`;
        const [firstname, ...lastnameParts] = cliente.nombre.split(' ');
        document.getElementById('firstname-input').value = firstname || '';
        document.getElementById('lastname-input').value = lastnameParts.join(' ') || '';
        document.getElementById('phone-input').value = cliente.telefono || '';
        document.getElementById('email-input').value = cliente.email || '';
        document.getElementById('pais-input').value = cliente.pais || '';
        document.getElementById('region-input').value = cliente.region || '';
        document.getElementById('ciudad-input').value = cliente.ciudad || '';
        document.getElementById('fuente-select').value = cliente.fuente || 'boca a boca';
        document.getElementById('calificacion-stars').dataset.rating = cliente.calificacion || 0;
        updateStarDisplay(cliente.calificacion || 0);
        document.getElementById('notas-input').value = cliente.notas || '';
        
        modalStatus.textContent = '';
        modal.classList.remove('hidden');

        await loadHistorial(editingClientId);
    }

    async function loadHistorial(clienteId) {
        const container = document.getElementById('historial-reservas-container');
        container.innerHTML = '<p class="text-gray-500">Cargando historial...</p>';
        try {
            const historial = await fetchAPI(`/api/reservas/cliente/${clienteId}`);
            if (historial.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No hay reservas anteriores.</p>';
                return;
            }
            container.innerHTML = `
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="p-2">Fechas</th>
                            <th class="p-2">Cabaña</th>
                            <th class="p-2">Canal</th>
                            <th class="p-2">Monto</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${historial.map(r => `
                            <tr class="border-b">
                                <td class="p-2">${r.llegada} - ${r.salida}</td>
                                <td class="p-2">${r.alojamiento}</td>
                                <td class="p-2">${r.canal}</td>
                                <td class="p-2">$${(r.valorCLP || 0).toLocaleString('es-CL')}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        } catch (error) {
            container.innerHTML = `<p class="text-red-500">Error al cargar historial: ${error.message}</p>`;
        }
    }

    async function handleSave() {
        if (!editingClientId) return;

        const payload = {
            firstname: document.getElementById('firstname-input').value.trim(),
            lastname: document.getElementById('lastname-input').value.trim(),
            phone: document.getElementById('phone-input').value.trim(),
            email: document.getElementById('email-input').value.trim(),
            pais: document.getElementById('pais-input').value.trim(),
            region: document.getElementById('region-input').value.trim(),
            ciudad: document.getElementById('ciudad-input').value.trim(),
            fuente: document.getElementById('fuente-select').value,
            calificacion: document.getElementById('calificacion-stars').dataset.rating,
            notas: document.getElementById('notas-input').value.trim()
        };

        saveBtn.disabled = true;
        saveBtn.textContent = 'Guardando...';
        modalStatus.textContent = '';
        
        try {
            const result = await fetchAPI(`/api/clientes/${editingClientId}`, { method: 'PUT', body: payload });
            modal.classList.add('hidden');
            await loadClients();
        } catch (error) {
            modalStatus.textContent = `Error: ${error.message}`;
            modalStatus.className = 'mt-2 text-sm text-red-600';
        } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = 'Guardar Cambios';
            editingClientId = null;
        }
    }

    async function handleDelete() {
        if (!editingClientId) return;

        const cliente = allClients.find(c => c.id === editingClientId);
        if (!cliente) return;
        
        if (!confirm(`¿Estás SEGURO de que quieres eliminar a "${cliente.nombre}"? Esta acción no se puede deshacer.`)) {
            return;
        }
        if (!confirm(`CONFIRMACIÓN FINAL: ¿Eliminar a "${cliente.nombre}" permanentemente?`)) {
            return;
        }

        deleteBtn.disabled = true;
        deleteBtn.textContent = 'Eliminando...';
        modalStatus.textContent = '';

        try {
            const result = await fetchAPI(`/api/clientes/${editingClientId}`, { method: 'DELETE' });
            alert(result.message);
            modal.classList.add('hidden');
            await loadClients();
        } catch (error) {
            modalStatus.textContent = `Error: ${error.message}`;
            modalStatus.className = 'mt-2 text-sm text-red-600';
        } finally {
            deleteBtn.disabled = false;
            deleteBtn.textContent = 'Eliminar Cliente';
            editingClientId = null;
        }
    }

    function updateTableView() {
        const searchTerm = searchInput.value.toLowerCase();
        const filteredClients = allClients.filter(c =>
            (c.nombre && c.nombre.toLowerCase().includes(searchTerm)) ||
            (c.telefono && c.telefono.toLowerCase().includes(searchTerm)) ||
            (c.email && c.email.toLowerCase().includes(searchTerm))
        );
        renderTable(filteredClients);
    }

    async function loadClients() {
        loadingState.style.display = 'block';
        try {
            allClients = await fetchAPI('/api/clientes');
            updateTableView();
        } catch (error) {
            console.error('Error al cargar clientes:', error);
            loadingState.innerHTML = `<p class="text-red-500 font-semibold">No se pudieron cargar los clientes: ${error.message}</p>`;
        }
    }

    populateDropdowns();
    setupStars();
    searchInput.addEventListener('input', updateTableView);
    cancelBtn.addEventListener('click', () => modal.classList.add('hidden'));
    saveBtn.addEventListener('click', handleSave);
    deleteBtn.addEventListener('click', handleDelete);
    loadClients();
</script>