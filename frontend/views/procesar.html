<div class="bg-white p-6 md:p-8 rounded-lg shadow">
    <h2 class="text-2xl font-semibold text-gray-900 mb-2">Consolidar Reportes</h2>
    <p class="text-gray-600 mb-6">Este proceso leerá los reportes brutos que subiste, los limpiará, transformará y guardará en las colecciones finales 'clientes' y 'reservas'.</p>
    <div class="mt-4">
        <button id="consolidate-btn" class="w-full sm:w-auto inline-flex justify-center items-center px-8 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700">
            Iniciar Proceso de Consolidación
        </button>
    </div>
    <div id="consolidate-status" class="mt-6 p-4 rounded-md hidden"></div>
</div>

<script type="module">
    import { fetchAPI } from '/gestor-reservas/api.js';


    const consolidateBtn = document.getElementById('consolidate-btn');
    const consolidateStatus = document.getElementById('consolidate-status');

    function showStatus(element, message, isError = false) {
        element.innerHTML = message;
        let statusClass = isError ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800';
         if (message.includes('¡Proceso de consolidación finalizado!')) {
            statusClass = 'bg-green-100 text-green-800';
        }
        element.className = `mt-6 p-4 rounded-md text-sm ${statusClass}`;
        element.classList.remove('hidden');
    }

    consolidateBtn.addEventListener('click', async () => {
        consolidateBtn.disabled = true;
        consolidateBtn.textContent = 'Procesando...';
        showStatus(consolidateStatus, 'Iniciando consolidación. Esto puede tardar varios segundos...');
        try {
            const result = await fetchAPI('/api/consolidar', {
                method: 'POST'
            });
            
            const sodc = result.summary.sodc;
            const booking = result.summary.booking;

            let summaryHtml = `
                <strong>¡Proceso de consolidación finalizado!</strong>
                <div class="grid grid-cols-2 gap-4 mt-2">
                    <div>
                        <h4 class="font-semibold">SODC</h4>
                        <ul class="list-disc list-inside text-sm">
                            <li>Reportes procesados: <strong>${sodc.reportesEncontrados}</strong></li>
                            <li>Reservas creadas: <strong>${sodc.reservasCreadas}</strong></li>
                            <li>Reservas actualizadas: <strong>${sodc.reservasActualizadas}</strong></li>
                            <li>Clientes nuevos: <strong>${sodc.clientesNuevos}</strong></li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="font-semibold">Booking</h4>
                        <ul class="list-disc list-inside text-sm">
                            <li>Reportes procesados: <strong>${booking.reportesEncontrados}</strong></li>
                            <li>Reservas creadas: <strong>${booking.reservasCreadas}</strong></li>
                            <li>Reservas actualizadas: <strong>${booking.reservasActualizadas}</strong></li>
                            <li>Clientes nuevos: <strong>${booking.clientesNuevos}</strong></li>
                        </ul>
                    </div>
                </div>
            `;
            showStatus(consolidateStatus, summaryHtml);

        } catch (error) {
            console.error('Error al consolidar:', error);
            showStatus(consolidateStatus, `<strong>Error:</strong> ${error.message}`, true);
        } finally {
            consolidateBtn.disabled = false;
            consolidateBtn.textContent = 'Iniciar Proceso de Consolidación';
        }
    });
</script>