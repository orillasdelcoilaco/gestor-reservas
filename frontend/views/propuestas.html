<div class="bg-white p-6 md:p-8 rounded-lg shadow">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
        <h2 class="text-2xl font-semibold text-gray-900">Propuestas Pendientes de Aprobación</h2>
    </div>
    
    <div class="overflow-x-auto border rounded-lg">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha Propuesta</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cliente</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha Llegada</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cabañas</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Valor Total</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                </tr>
            </thead>
            <tbody id="propuestas-table-body" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
    </div>
    <div id="loading-state" class="text-center p-8">
        <p class="text-gray-500">Cargando propuestas...</p>
    </div>
</div>

<div id="reject-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
        <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Rechazar Propuesta</h3>
        <form id="reject-form" class="space-y-4">
            <div>
                <label for="reject-reason" class="block text-sm font-medium text-gray-700">Motivo del Rechazo</label>
                <select id="reject-reason" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    <option value="Precio">Precio</option>
                    <option value="No Abonado">No Abonado a tiempo</option>
                    <option value="Cambio de fechas">Cliente solicitó cambio de fechas</option>
                    <option value="Otro">Otro (especificar en la nota)</option>
                </select>
            </div>
            <div>
                <label for="reject-note" class="block text-sm font-medium text-gray-700">Nota Adicional</label>
                <textarea id="reject-note" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="Añade más detalles aquí..."></textarea>
            </div>
            <div id="reject-status" class="text-sm text-red-600"></div>
            <div class="mt-5 flex justify-end space-x-3">
                <button type="button" id="reject-cancel-btn" class="px-4 py-2 bg-gray-200 rounded-md text-sm">Cancelar</button>
                <button type="submit" id="reject-save-btn" class="px-4 py-2 bg-red-600 text-white rounded-md text-sm">Confirmar Rechazo</button>
            </div>
        </form>
    </div>
</div>

<script type="module">
    import { fetchAPI } from '../api.js';

    const tableBody = document.getElementById('propuestas-table-body');
    const loadingState = document.getElementById('loading-state');
    const rejectModal = document.getElementById('reject-modal');
    const rejectForm = document.getElementById('reject-form');
    const rejectCancelBtn = document.getElementById('reject-cancel-btn');
    let currentProposalId = null;

    async function loadPropuestas() {
        loadingState.style.display = 'block';
        tableBody.innerHTML = '';
        try {
            const propuestas = await fetchAPI('/api/reservas/propuestas');
            if (propuestas.length === 0) {
                loadingState.innerHTML = '<p class="text-gray-500">No hay propuestas pendientes.</p>';
                return;
            }
            renderTable(propuestas);
            loadingState.style.display = 'none';
        } catch (error) {
            loadingState.innerHTML = `<p class="text-red-500">Error al cargar propuestas: ${error.message}</p>`;
        }
    }

    function renderTable(propuestas) {
        propuestas.forEach(p => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${p.fechaReserva}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-800">${p.clienteNombre}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${p.fechaLlegada}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${p.cabañas.join(', ')}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold">$${p.valorTotal.toLocaleString('es-CL')}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                    <button data-id="${p.id}" class="confirm-btn px-2 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600">Confirmar</button>
                    <button data-id="${p.id}" class="cancel-btn px-2 py-1 bg-yellow-500 text-white text-xs rounded hover:bg-yellow-600">Cancelar</button>
                    <button data-id="${p.id}" class="reject-btn px-2 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600">Rechazar</button>
                </td>
            `;
            tableBody.appendChild(row);
        });

        document.querySelectorAll('.confirm-btn').forEach(b => b.addEventListener('click', e => handleStateChange(e.target.dataset.id, 'Confirmada')));
        document.querySelectorAll('.cancel-btn').forEach(b => b.addEventListener('click', e => handleStateChange(e.target.dataset.id, 'Cancelada')));
        document.querySelectorAll('.reject-btn').forEach(b => b.addEventListener('click', e => openRejectModal(e.target.dataset.id)));
    }
    
    async function handleStateChange(id, nuevoEstado) {
        const action = nuevoEstado === 'Confirmada' ? 'confirmar' : 'cancelar';
        if (!confirm(`¿Estás seguro de que quieres ${action} esta propuesta?`)) return;

        try {
            const result = await fetchAPI(`/api/reservas/propuestas/${id}/estado`, { 
                method: 'POST', 
                body: { nuevoEstado }
            });
            alert(result.message);
            loadPropuestas();
        } catch(error) {
            alert(`Error al ${action}: ${error.message}`);
        }
    }

    function openRejectModal(id) {
        currentProposalId = id;
        rejectForm.reset();
        document.getElementById('reject-status').textContent = '';
        rejectModal.classList.remove('hidden');
    }

    rejectCancelBtn.addEventListener('click', () => {
        rejectModal.classList.add('hidden');
        currentProposalId = null;
    });

    rejectForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!currentProposalId) return;

        const saveBtn = document.getElementById('reject-save-btn');
        const statusEl = document.getElementById('reject-status');
        
        saveBtn.disabled = true;
        saveBtn.textContent = 'Guardando...';
        statusEl.textContent = '';

        const payload = {
            motivo: document.getElementById('reject-reason').value,
            nota: document.getElementById('reject-note').value
        };

        try {
            const result = await fetchAPI(`/api/reservas/propuestas/${currentProposalId}/rechazar`, {
                method: 'POST',
                body: payload
            });
            alert(result.message);
            rejectModal.classList.add('hidden');
            loadPropuestas();
        } catch (error) {
            statusEl.textContent = `Error: ${error.message}`;
        } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = 'Confirmar Rechazo';
        }
    });

    loadPropuestas();
</script>